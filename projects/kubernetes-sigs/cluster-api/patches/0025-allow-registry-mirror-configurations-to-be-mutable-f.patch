From d062573e34aea1f0f41d2f2e2796094d60fc4bde Mon Sep 17 00:00:00 2001
From: Cavaughn Browne <cxbrowne@amazon.com>
Date: Thu, 20 Jul 2023 11:05:49 -0500
Subject: [PATCH 25/36] allow registry mirror configurations to be mutable for
 BR

---
 .../internal/webhooks/kubeadmcontrolplane.go  |  2 +
 .../webhooks/kubeadmcontrolplane_test.go      | 45 +++++++++++++++++++
 2 files changed, 47 insertions(+)

diff --git a/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane.go b/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane.go
index 922dddcf4..9c8c27bc1 100644
--- a/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane.go
+++ b/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane.go
@@ -163,6 +163,7 @@ func (webhook *KubeadmControlPlane) ValidateUpdate(_ context.Context, oldObj, ne
 		{spec, kubeadmConfigSpec, clusterConfiguration, controllerManager, "*"},
 		{spec, kubeadmConfigSpec, clusterConfiguration, scheduler},
 		{spec, kubeadmConfigSpec, clusterConfiguration, scheduler, "*"},
+		{spec, kubeadmConfigSpec, clusterConfiguration, "registryMirror", "*"},
 		{spec, kubeadmConfigSpec, clusterConfiguration, "certificateValidityPeriodDays"},
 		{spec, kubeadmConfigSpec, clusterConfiguration, "encryptionAlgorithm"},
 		// spec.kubeadmConfigSpec.initConfiguration
@@ -182,6 +183,7 @@ func (webhook *KubeadmControlPlane) ValidateUpdate(_ context.Context, oldObj, ne
 		{spec, kubeadmConfigSpec, joinConfiguration, "bottlerocketControl", "*"},
 		{spec, kubeadmConfigSpec, joinConfiguration, "bottlerocketCustomBootstrapContainers"},
 		{spec, kubeadmConfigSpec, joinConfiguration, "bottlerocketSettings", "*"},
+		{spec, kubeadmConfigSpec, joinConfiguration, "registryMirror", "*"},
 		{spec, kubeadmConfigSpec, joinConfiguration, "pause", "*"},
 		{spec, kubeadmConfigSpec, joinConfiguration, nodeRegistration},
 		{spec, kubeadmConfigSpec, joinConfiguration, nodeRegistration, "*"},
diff --git a/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane_test.go b/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane_test.go
index b53fa3d7f..5d31bf678 100644
--- a/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane_test.go
+++ b/controlplane/kubeadm/internal/webhooks/kubeadmcontrolplane_test.go
@@ -360,6 +360,10 @@ func TestKubeadmControlPlaneValidateUpdate(t *testing.T) {
 					CertificateValidityPeriodDays:   100,
 					CACertificateValidityPeriodDays: 365,
 					EncryptionAlgorithm:             bootstrapv1.EncryptionAlgorithmRSA2048,
+					RegistryMirror: bootstrapv1.RegistryMirrorConfiguration{
+						Endpoint: "https://1.1.1.1:1111",
+						CACert:   "test-cert",
+					},
 				},
 				JoinConfiguration: bootstrapv1.JoinConfiguration{
 					NodeRegistration: bootstrapv1.NodeRegistrationOptions{
@@ -369,6 +373,10 @@ func TestKubeadmControlPlaneValidateUpdate(t *testing.T) {
 						ControlPlaneComponentHealthCheckSeconds: ptr.To[int32](10),
 						KubeletHealthCheckSeconds:               ptr.To[int32](40),
 					},
+					RegistryMirror: bootstrapv1.RegistryMirrorConfiguration{
+						Endpoint: "https://1.1.1.1:1111",
+						CACert:   "test-cert",
+					},
 				},
 				PreKubeadmCommands: []string{
 					"test", "foo",
@@ -789,6 +797,18 @@ func TestKubeadmControlPlaneValidateUpdate(t *testing.T) {
 	validUpdateJoinConfBRCustomBootstrapContainers := before.DeepCopy()
 	validUpdateJoinConfBRCustomBootstrapContainers.Spec.KubeadmConfigSpec.JoinConfiguration.BottlerocketCustomBootstrapContainers = []bootstrapv1.BottlerocketBootstrapContainer{{ImageRepository: "registry.k8s.io/bottlerocketbootstrap", ImageTag: "v1.1.0+new"}}
 
+	validUpdateClusterConfigRegistryMirrorCACert := before.DeepCopy()
+	validUpdateClusterConfigRegistryMirrorCACert.Spec.KubeadmConfigSpec.ClusterConfiguration.RegistryMirror.CACert = "foo:bar"
+
+	validUpdateJoinConfigRegistryMirrorCACert := before.DeepCopy()
+	validUpdateJoinConfigRegistryMirrorCACert.Spec.KubeadmConfigSpec.JoinConfiguration.RegistryMirror.CACert = "foo:bar"
+
+	validUpdateClusterConfigRegistryMirrorEndpoint := before.DeepCopy()
+	validUpdateClusterConfigRegistryMirrorEndpoint.Spec.KubeadmConfigSpec.ClusterConfiguration.RegistryMirror.Endpoint = "https://0.0.0.0:6443"
+
+	validUpdateJoinConfigRegistryMirrorEndpoint := before.DeepCopy()
+	validUpdateJoinConfigRegistryMirrorEndpoint.Spec.KubeadmConfigSpec.JoinConfiguration.RegistryMirror.Endpoint = "https://0.0.0.0:6443"
+
 	tests := []struct {
 		name                  string
 		enableIgnitionFeature bool
@@ -1217,6 +1237,31 @@ func TestKubeadmControlPlaneValidateUpdate(t *testing.T) {
 			before:    before,
 			kcp:       validUpdateJoinConfBRCustomBootstrapContainers,
 		},
+		{
+			name:      "should allow changes to join configuration registry mirror caCert",
+			expectErr: false,
+			before:    before,
+			kcp:       validUpdateJoinConfigRegistryMirrorCACert,
+		},
+		{
+			name:      "should allow changes to join configuration registry mirror endpoint",
+			expectErr: false,
+			before:    before,
+			kcp:       validUpdateJoinConfigRegistryMirrorEndpoint,
+		},
+		{
+			name:      "should allow changes to cluster configuration registry mirror caCert",
+			expectErr: false,
+			before:    before,
+			kcp:       validUpdateClusterConfigRegistryMirrorCACert,
+		},
+
+		{
+			name:      "should allow changes to cluster configuration registry mirror endpoint",
+			expectErr: false,
+			before:    before,
+			kcp:       validUpdateClusterConfigRegistryMirrorEndpoint,
+		},
 	}
 
 	for _, tt := range tests {
-- 
2.50.1 (Apple Git-155)

