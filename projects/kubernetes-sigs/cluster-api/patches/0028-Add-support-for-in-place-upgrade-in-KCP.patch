From be110fa6eac8872440ad1fea31d6a0511a05f85c Mon Sep 17 00:00:00 2001
From: Abhinav Pandey <abhinavmpandey08@gmail.com>
Date: Wed, 17 Jan 2024 09:28:18 -0800
Subject: [PATCH 28/36] Add support for in-place upgrade in KCP

---
 .../v1beta2/kubeadm_control_plane_types.go     | 18 +++++++++++++++---
 ....cluster.x-k8s.io_kubeadmcontrolplanes.yaml |  9 +++++++--
 ....x-k8s.io_kubeadmcontrolplanetemplates.yaml |  9 +++++++--
 .../kubeadm/internal/controllers/upgrade.go    |  8 +++++++-
 .../internal/webhooks/kubeadm_control_plane.go |  4 ++--
 5 files changed, 38 insertions(+), 10 deletions(-)

diff --git a/api/controlplane/kubeadm/v1beta2/kubeadm_control_plane_types.go b/api/controlplane/kubeadm/v1beta2/kubeadm_control_plane_types.go
index acb926355..e22f5d729 100644
--- a/api/controlplane/kubeadm/v1beta2/kubeadm_control_plane_types.go
+++ b/api/controlplane/kubeadm/v1beta2/kubeadm_control_plane_types.go
@@ -26,13 +26,16 @@ import (
 )
 
 // KubeadmControlPlaneRolloutStrategyType defines the rollout strategies for a KubeadmControlPlane.
-// +kubebuilder:validation:Enum=RollingUpdate
+// +kubebuilder:validation:Enum=RollingUpdate;InPlace
 type KubeadmControlPlaneRolloutStrategyType string
 
 const (
 	// RollingUpdateStrategyType replaces the old control planes by new one using rolling update
 	// i.e. gradually scale up or down the old control planes and scale up or down the new one.
 	RollingUpdateStrategyType KubeadmControlPlaneRolloutStrategyType = "RollingUpdate"
+
+	// InPlaceUpgradeStrategyType updates the node in place by delegating the upgrade to an external entity.
+	InPlaceUpgradeStrategyType KubeadmControlPlaneRolloutStrategyType = "InPlace"
 )
 
 const (
@@ -72,6 +75,11 @@ const (
 	// DefaultMinHealthyPeriodSeconds defines the default minimum period before we consider a remediation on a
 	// machine unrelated from the previous remediation.
 	DefaultMinHealthyPeriodSeconds = int32(60 * 60)
+
+	// InPlaceUpgradeAnnotation is used to denote that the KCP object needs to be in-place upgraded by an external entity.
+	// This annotation will be added to the KCP object when `rolloutStrategy.type` is set to `InPlace`.
+	// The external upgrader entity should watch for the annotation and trigger an upgrade when it's added.
+	InPlaceUpgradeAnnotation = "controlplane.clusters.x-k8s.io/in-place-upgrade-needed"
 )
 
 // KubeadmControlPlane's Available condition and corresponding reasons.
@@ -573,8 +581,12 @@ type KubeadmControlPlaneRolloutBeforeSpec struct {
 // with new ones.
 // +kubebuilder:validation:MinProperties=1
 type KubeadmControlPlaneRolloutStrategy struct {
-	// type of rollout. Currently the only supported strategy is
-	// "RollingUpdate".
+	// type of rollout strategy to use.
+	// Supported values:
+	// - `RollingUpdate`: RollingUpdateStrategyType replaces the old control planes by new one using rolling update
+	// i.e. gradually scale up or down the old control planes and scale up or down the new one.
+	// - `InPlace`: updates the node in place by delegating the upgrade to an external entity.
+	//
 	// Default is RollingUpdate.
 	// +required
 	Type KubeadmControlPlaneRolloutStrategyType `json:"type,omitempty"`
diff --git a/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanes.yaml b/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanes.yaml
index ba8a636af..3c100593a 100644
--- a/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanes.yaml
+++ b/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanes.yaml
@@ -5703,11 +5703,16 @@ spec:
                     type: object
                   type:
                     description: |-
-                      type of rollout. Currently the only supported strategy is
-                      "RollingUpdate".
+                      type of rollout strategy to use.
+                      Supported values:
+                      - `RollingUpdate`: RollingUpdateStrategyType replaces the old control planes by new one using rolling update
+                      i.e. gradually scale up or down the old control planes and scale up or down the new one.
+                      - `InPlace`: updates the node in place by delegating the upgrade to an external entity.
+
                       Default is RollingUpdate.
                     enum:
                     - RollingUpdate
+                    - InPlace
                     type: string
                 type: object
               version:
diff --git a/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanetemplates.yaml b/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanetemplates.yaml
index e0adc0170..6d43abc3e 100644
--- a/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanetemplates.yaml
+++ b/controlplane/kubeadm/config/crd/bases/controlplane.cluster.x-k8s.io_kubeadmcontrolplanetemplates.yaml
@@ -4359,11 +4359,16 @@ spec:
                             type: object
                           type:
                             description: |-
-                              type of rollout. Currently the only supported strategy is
-                              "RollingUpdate".
+                              type of rollout strategy to use.
+                              Supported values:
+                              - `RollingUpdate`: RollingUpdateStrategyType replaces the old control planes by new one using rolling update
+                              i.e. gradually scale up or down the old control planes and scale up or down the new one.
+                              - `InPlace`: updates the node in place by delegating the upgrade to an external entity.
+
                               Default is RollingUpdate.
                             enum:
                             - RollingUpdate
+                            - InPlace
                             type: string
                         type: object
                     required:
diff --git a/controlplane/kubeadm/internal/controllers/upgrade.go b/controlplane/kubeadm/internal/controllers/upgrade.go
index d267a4205..86ccd7489 100644
--- a/controlplane/kubeadm/internal/controllers/upgrade.go
+++ b/controlplane/kubeadm/internal/controllers/upgrade.go
@@ -18,6 +18,7 @@ package controllers
 
 import (
 	"context"
+	"time"
 
 	"github.com/blang/semver/v4"
 	"github.com/pkg/errors"
@@ -27,6 +28,7 @@ import (
 	bootstrapv1 "sigs.k8s.io/cluster-api/api/bootstrap/kubeadm/v1beta2"
 	controlplanev1 "sigs.k8s.io/cluster-api/api/controlplane/kubeadm/v1beta2"
 	"sigs.k8s.io/cluster-api/controlplane/kubeadm/internal"
+	"sigs.k8s.io/cluster-api/util/annotations"
 	"sigs.k8s.io/cluster-api/util/collections"
 )
 
@@ -94,8 +96,12 @@ func (r *KubeadmControlPlaneReconciler) upgradeControlPlane(
 			return r.scaleUpControlPlane(ctx, controlPlane)
 		}
 		return r.scaleDownControlPlane(ctx, controlPlane, machinesRequireUpgrade)
+	case controlplanev1.InPlaceUpgradeStrategyType:
+		annotations.AddAnnotations(controlPlane.KCP, map[string]string{controlplanev1.InPlaceUpgradeAnnotation: "true"})
+		logger.Info("RolloutStrategy type set to InPlaceUpgradeStrategyType, adding the annotation and requeuing", "annotation", controlplanev1.InPlaceUpgradeAnnotation)
+		return ctrl.Result{RequeueAfter: time.Second * 30}, nil
 	default:
-		logger.Info("RolloutStrategy type is not set to RollingUpdate, unable to determine the strategy for rolling out machines")
+		logger.Info("RolloutStrategy type is not set to RollingUpdateStrategyType or InPlaceUpgradeStrategyType, unable to determine the strategy for rolling out machines")
 		return ctrl.Result{}, nil
 	}
 }
diff --git a/controlplane/kubeadm/internal/webhooks/kubeadm_control_plane.go b/controlplane/kubeadm/internal/webhooks/kubeadm_control_plane.go
index b3f591608..083dab58d 100644
--- a/controlplane/kubeadm/internal/webhooks/kubeadm_control_plane.go
+++ b/controlplane/kubeadm/internal/webhooks/kubeadm_control_plane.go
@@ -375,12 +375,12 @@ func validateRolloutAndCertValidityFields(rolloutSpec controlplanev1.KubeadmCont
 		return nil
 	}
 
-	if rolloutStrategy.Type != controlplanev1.RollingUpdateStrategyType {
+	if rolloutStrategy.Type != controlplanev1.RollingUpdateStrategyType && rolloutStrategy.Type != controlplanev1.InPlaceUpgradeStrategyType {
 		allErrs = append(
 			allErrs,
 			field.Required(
 				pathPrefix.Child("rollout", "strategy", "type"),
-				"only RollingUpdate is supported",
+				"only RollingUpdateStrategyType and InPlaceUpgradeStrategyType are supported",
 			),
 		)
 	}
-- 
2.49.0

