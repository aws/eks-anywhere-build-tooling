From 0e16d0d44f1e5ab2041f6e6fb6a9cecc15b601c4 Mon Sep 17 00:00:00 2001
From: Prow Bot <jgw@amazon.com>
Date: Mon, 10 Jul 2023 14:34:01 -0500
Subject: [PATCH 18/18] adds disable udp service for redhat on vmware

---
 .../systemd/system/disable-udp-offload.service | 15 +++++++++++++++
 .../roles/providers/tasks/vmware-redhat.yml    | 18 ++++++++++++++++++
 2 files changed, 33 insertions(+)
 create mode 100644 images/capi/ansible/roles/providers/files/etc/systemd/system/disable-udp-offload.service

diff --git a/images/capi/ansible/roles/providers/files/etc/systemd/system/disable-udp-offload.service b/images/capi/ansible/roles/providers/files/etc/systemd/system/disable-udp-offload.service
new file mode 100644
index 000000000..247a42c56
--- /dev/null
+++ b/images/capi/ansible/roles/providers/files/etc/systemd/system/disable-udp-offload.service
@@ -0,0 +1,15 @@
+[Unit]
+Description=Disables UDP offload
+After=NetworkManager-wait-online.service
+# Block manual interactions with this service
+RefuseManualStart=true
+RefuseManualStop=true
+
+[Service]
+Type=oneshot
+ExecStart=/usr/sbin/ethtool -K eth0 tx-udp_tnl-segmentation off
+ExecStart=/usr/sbin/ethtool -K eth0 tx-udp_tnl-csum-segmentation off
+RemainAfterExit=true
+
+[Install]
+WantedBy=multi-user.target
diff --git a/images/capi/ansible/roles/providers/tasks/vmware-redhat.yml b/images/capi/ansible/roles/providers/tasks/vmware-redhat.yml
index 0047e90a7..105348b2f 100644
--- a/images/capi/ansible/roles/providers/tasks/vmware-redhat.yml
+++ b/images/capi/ansible/roles/providers/tasks/vmware-redhat.yml
@@ -49,3 +49,21 @@
   file:
     path:  /tmp/cloud-init-vmware.sh
     state: absent
+
+- name: Create service disable udp offload
+  copy:
+    src: files/etc/systemd/system/disable-udp-offload.service
+    dest: /etc/systemd/system/disable-udp-offload.service
+    owner: root
+    group: root
+    mode: 0644
+  when: ansible_os_family != "Flatcar"
+
+- name: Enable disable-udp-offload.service
+  systemd:
+    name: disable-udp-offload.service
+    daemon_reload: yes
+    enabled: True
+    state: stopped
+  when: ansible_os_family != "Flatcar"
+  
\ No newline at end of file
-- 
2.40.1

