From 4657712fc9c051a324032348bf812ad68b799edd Mon Sep 17 00:00:00 2001
From: Abhay Krishna Arunachalam <arnchlm@amazon.com>
Date: Thu, 19 Sep 2024 16:04:19 -0700
Subject: [PATCH 10/19] Remove containerd configuration for hosts.toml paths

In EKS Anywhere, we're still using the older containerd config template (v2), so setting the
config_path in the containerd config file causes errors like "invalid plugin config: `mirrors`
cannot be set when `config_path` is provided" in registry mirror tests. Thus we're reverting the
change that added the config path.

Signed-off-by: Abhay Krishna Arunachalam <arnchlm@amazon.com>
---
 images/capi/ansible/roles/containerd/tasks/main.yml         | 6 ------
 .../roles/containerd/templates/etc/containerd/config.toml   | 2 --
 2 files changed, 8 deletions(-)

diff --git a/images/capi/ansible/roles/containerd/tasks/main.yml b/images/capi/ansible/roles/containerd/tasks/main.yml
index cd0368f0b..f2894123f 100644
--- a/images/capi/ansible/roles/containerd/tasks/main.yml
+++ b/images/capi/ansible/roles/containerd/tasks/main.yml
@@ -169,12 +169,6 @@
     state: directory
     mode: "0755"
 
-- name: Creates containerd certificates directory
-  ansible.builtin.file:
-    path: /etc/containerd/certs.d
-    state: directory
-    mode: "0755"
-
 - name: Copy in containerd config file {{ containerd_config_file }}
   vars:
     runtime_versions: "{{ containerd_wasm_shims_runtime_versions | from_json }}"
diff --git a/images/capi/ansible/roles/containerd/templates/etc/containerd/config.toml b/images/capi/ansible/roles/containerd/templates/etc/containerd/config.toml
index 2625d6e58..cc31ee17e 100644
--- a/images/capi/ansible/roles/containerd/templates/etc/containerd/config.toml
+++ b/images/capi/ansible/roles/containerd/templates/etc/containerd/config.toml
@@ -47,8 +47,6 @@ imports = ["/etc/containerd/conf.d/*.toml"]
 {% else %}
   [plugins."io.containerd.grpc.v1.cri"]
     sandbox_image = "{{ pause_image }}"
-  [plugins."io.containerd.grpc.v1.cri".registry]
-    config_path = "/etc/containerd/certs.d"
 {% if kubernetes_semver is version('v1.21.0', '>=') %}
   [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
     runtime_type = "io.containerd.runc.v2"
-- 
2.45.2

