From 75252ee3aedadd917e70824b5c88db65217d88b0 Mon Sep 17 00:00:00 2001
From: Abhay Krishna Arunachalam <arnchlm@amazon.com>
Date: Tue, 15 Oct 2024 05:48:20 +0530
Subject: [PATCH] Set SSH password dynamically during auto-install

---
 images/capi/Makefile                          | 52 +++++++++++++------
 images/capi/hack/set-ssh-password.sh          | 49 +++++++++++++++++
 images/capi/packer/nutanix/.gitignore         |  2 ++
 .../linux/cloud-init/rhel/8/user-data.tmpl    |  9 ++++
 .../linux/cloud-init/rhel/9/user-data.tmpl    |  9 ++++
 .../cloud-init/rockylinux/8/user-data.tmpl    |  9 ++++
 .../cloud-init/rockylinux/9/user-data.tmpl    |  9 ++++
 .../cloud-init/ubuntu/20.04/user-data.tmpl    | 10 ++++
 .../cloud-init/ubuntu/22.04/user-data.tmpl    | 10 ++++
 .../cloud-init/ubuntu/24.04/user-data.tmpl    | 10 ++++
 .../nutanix/{packer.json => packer.json.tmpl} |  2 +-
 images/capi/packer/ova/.gitignore             |  6 +++
 .../7/ks.cfg => centos/http/7/ks.cfg.tmpl}    |  2 +-
 .../centos/http/8/{ks.cfg => ks.cfg.tmpl}     |  2 +-
 .../photon/http/{4/ks.json => 3/ks.json.tmpl} |  2 +-
 .../photon/http/{3/ks.json => 4/ks.json.tmpl} |  2 +-
 .../photon/http/5/{ks.json => ks.json.tmpl}   |  2 +-
 .../http/7/ks.cfg => rhel/http/7/ks.cfg.tmpl} |  2 +-
 .../linux/rhel/http/8/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../linux/rhel/http/9/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../rockylinux/http/8/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../rockylinux/http/9/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../22.04.efi/{user-data => user-data.tmpl}   |  4 +-
 .../http/22.04/{user-data => user-data.tmpl}  |  4 +-
 .../24.04.efi/{user-data => user-data.tmpl}   |  4 +-
 .../http/24.04/{user-data => user-data.tmpl}  |  4 +-
 .../{preseed-efi.cfg => preseed-efi.cfg.tmpl} |  4 +-
 .../base/{preseed.cfg => preseed.cfg.tmpl}    |  4 +-
 ...er-common.json => packer-common.json.tmpl} |  2 +-
 images/capi/packer/proxmox/.gitignore         |  3 ++
 .../rockylinux/http/9/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../http/22.04/{user-data => user-data.tmpl}  |  4 +-
 .../http/24.04/{user-data => user-data.tmpl}  |  4 +-
 .../proxmox/{packer.json => packer.json.tmpl} |  2 +-
 images/capi/packer/qemu/.gitignore            |  5 ++
 .../cloud-init/{user-data => user-data.tmpl}  |  2 +-
 .../centos/http/7/{ks.cfg => ks.cfg.tmpl}     |  2 +-
 .../8/ks.cfg => centos/http/8/ks.cfg.tmpl}    |  2 +-
 .../centos/http/9/{ks.cfg => ks.cfg.tmpl}     |  2 +-
 .../http/8/ks.cfg => rhel/http/8/ks.cfg.tmpl} |  2 +-
 .../linux/rhel/http/9/ks.cfg.tmpl}            |  2 +-
 .../rockylinux/http/8/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../rockylinux/http/9/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../{user-data => user-data.tmpl}             |  4 +-
 .../22.04.efi/{user-data => user-data.tmpl}   |  4 +-
 .../http/22.04/{user-data => user-data.tmpl}  |  4 +-
 .../{24.04/user-data => 23.04/user-data.tmpl} |  4 +-
 .../24.04.efi/{user-data => user-data.tmpl}   |  4 +-
 .../{23.04/user-data => 24.04/user-data.tmpl} |  4 +-
 .../{preseed-efi.cfg => preseed-efi.cfg.tmpl} |  4 +-
 .../base/{preseed.cfg => preseed.cfg.tmpl}    |  4 +-
 .../qemu/{packer.json => packer.json.tmpl}    |  2 +-
 images/capi/packer/raw/.gitignore             |  5 ++
 .../linux/rhel/http/8/{ks.cfg => ks.cfg.tmpl} |  2 +-
 .../http/9/{ks-efi.cfg => ks-efi.cfg.tmpl}    |  2 +-
 .../linux/rhel/http/9/ks.cfg.tmpl}            |  2 +-
 .../22.04.efi/{user-data => user-data.tmpl}   |  4 +-
 .../http/22.04/{user-data => user-data.tmpl}  |  4 +-
 .../{preseed-efi.cfg => preseed-efi.cfg.tmpl} |  4 +-
 .../base/{preseed.cfg => preseed.cfg.tmpl}    |  4 +-
 .../raw/{packer.json => packer.json.tmpl}     |  2 +-
 61 files changed, 238 insertions(+), 84 deletions(-)
 create mode 100755 images/capi/hack/set-ssh-password.sh
 create mode 100644 images/capi/packer/nutanix/.gitignore
 create mode 100644 images/capi/packer/nutanix/linux/cloud-init/rhel/8/user-data.tmpl
 create mode 100644 images/capi/packer/nutanix/linux/cloud-init/rhel/9/user-data.tmpl
 create mode 100644 images/capi/packer/nutanix/linux/cloud-init/rockylinux/8/user-data.tmpl
 create mode 100644 images/capi/packer/nutanix/linux/cloud-init/rockylinux/9/user-data.tmpl
 create mode 100644 images/capi/packer/nutanix/linux/cloud-init/ubuntu/20.04/user-data.tmpl
 create mode 100644 images/capi/packer/nutanix/linux/cloud-init/ubuntu/22.04/user-data.tmpl
 create mode 100644 images/capi/packer/nutanix/linux/cloud-init/ubuntu/24.04/user-data.tmpl
 rename images/capi/packer/nutanix/{packer.json => packer.json.tmpl} (99%)
 create mode 100644 images/capi/packer/ova/.gitignore
 rename images/capi/packer/ova/linux/{rhel/http/7/ks.cfg => centos/http/7/ks.cfg.tmpl} (96%)
 rename images/capi/packer/ova/linux/centos/http/8/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/ova/linux/photon/http/{4/ks.json => 3/ks.json.tmpl} (96%)
 rename images/capi/packer/ova/linux/photon/http/{3/ks.json => 4/ks.json.tmpl} (96%)
 rename images/capi/packer/ova/linux/photon/http/5/{ks.json => ks.json.tmpl} (96%)
 rename images/capi/packer/ova/linux/{centos/http/7/ks.cfg => rhel/http/7/ks.cfg.tmpl} (96%)
 rename images/capi/packer/ova/linux/rhel/http/8/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/ova/linux/rhel/http/9/{ks.cfg => ks.cfg.tmpl} (94%)
 rename images/capi/packer/ova/linux/rockylinux/http/8/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/ova/linux/rockylinux/http/9/{ks.cfg => ks.cfg.tmpl} (94%)
 rename images/capi/packer/ova/linux/ubuntu/http/22.04.efi/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/ova/linux/ubuntu/http/22.04/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/ova/linux/ubuntu/http/24.04.efi/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/ova/linux/ubuntu/http/24.04/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/ova/linux/ubuntu/http/base/{preseed-efi.cfg => preseed-efi.cfg.tmpl} (97%)
 rename images/capi/packer/ova/linux/ubuntu/http/base/{preseed.cfg => preseed.cfg.tmpl} (98%)
 rename images/capi/packer/ova/{packer-common.json => packer-common.json.tmpl} (96%)
 create mode 100644 images/capi/packer/proxmox/.gitignore
 rename images/capi/packer/proxmox/linux/rockylinux/http/9/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/proxmox/linux/ubuntu/http/22.04/{user-data => user-data.tmpl} (91%)
 rename images/capi/packer/proxmox/linux/ubuntu/http/24.04/{user-data => user-data.tmpl} (92%)
 rename images/capi/packer/proxmox/{packer.json => packer.json.tmpl} (99%)
 create mode 100644 images/capi/packer/qemu/.gitignore
 rename images/capi/packer/qemu/cloud-init/{user-data => user-data.tmpl} (63%)
 rename images/capi/packer/qemu/linux/centos/http/7/{ks.cfg => ks.cfg.tmpl} (96%)
 rename images/capi/packer/qemu/linux/{rhel/http/8/ks.cfg => centos/http/8/ks.cfg.tmpl} (95%)
 rename images/capi/packer/qemu/linux/centos/http/9/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/qemu/linux/{centos/http/8/ks.cfg => rhel/http/8/ks.cfg.tmpl} (95%)
 rename images/capi/packer/{raw/linux/rhel/http/9/ks.cfg => qemu/linux/rhel/http/9/ks.cfg.tmpl} (95%)
 rename images/capi/packer/qemu/linux/rockylinux/http/8/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/qemu/linux/rockylinux/http/9/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/qemu/linux/ubuntu/http/22.04.efi.qemu/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/qemu/linux/ubuntu/http/22.04.efi/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/qemu/linux/ubuntu/http/22.04/{user-data => user-data.tmpl} (94%)
 rename images/capi/packer/qemu/linux/ubuntu/http/{24.04/user-data => 23.04/user-data.tmpl} (94%)
 rename images/capi/packer/qemu/linux/ubuntu/http/24.04.efi/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/qemu/linux/ubuntu/http/{23.04/user-data => 24.04/user-data.tmpl} (94%)
 rename images/capi/packer/qemu/linux/ubuntu/http/base/{preseed-efi.cfg => preseed-efi.cfg.tmpl} (97%)
 rename images/capi/packer/qemu/linux/ubuntu/http/base/{preseed.cfg => preseed.cfg.tmpl} (97%)
 rename images/capi/packer/qemu/{packer.json => packer.json.tmpl} (99%)
 create mode 100644 images/capi/packer/raw/.gitignore
 rename images/capi/packer/raw/linux/rhel/http/8/{ks.cfg => ks.cfg.tmpl} (95%)
 rename images/capi/packer/raw/linux/rhel/http/9/{ks-efi.cfg => ks-efi.cfg.tmpl} (95%)
 rename images/capi/packer/{qemu/linux/rhel/http/9/ks.cfg => raw/linux/rhel/http/9/ks.cfg.tmpl} (95%)
 rename images/capi/packer/raw/linux/ubuntu/http/22.04.efi/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/raw/linux/ubuntu/http/22.04/{user-data => user-data.tmpl} (95%)
 rename images/capi/packer/raw/linux/ubuntu/http/base/{preseed-efi.cfg => preseed-efi.cfg.tmpl} (97%)
 rename images/capi/packer/raw/linux/ubuntu/http/base/{preseed.cfg => preseed.cfg.tmpl} (97%)
 rename images/capi/packer/raw/{packer.json => packer.json.tmpl} (99%)

diff --git a/images/capi/Makefile b/images/capi/Makefile
index be8c81a0a..e1dce7af4 100644
--- a/images/capi/Makefile
+++ b/images/capi/Makefile
@@ -44,6 +44,14 @@ help: ## Display this help
 version: ## Display version of image-builder
 	@echo $(IB_VERSION)
 
+GET_UBUNTU_DOTTED_SEMVER=$(strip \
+	$(eval _UBUNTU_SEMVER:=$1) \
+	$(eval _UBUNTU_SEMVER:=$(subst ubuntu-2004,ubuntu-20.04,$(_UBUNTU_SEMVER))) \
+	$(eval _UBUNTU_SEMVER:=$(subst ubuntu-2204,ubuntu-22.04,$(_UBUNTU_SEMVER))) \
+	$(eval _UBUNTU_SEMVER:=$(subst ubuntu-2404,ubuntu-24.04,$(_UBUNTU_SEMVER))) \
+	$(_UBUNTU_SEMVER) \
+)
+
 ## --------------------------------------
 ## Dependencies
 ## --------------------------------------
@@ -174,6 +182,13 @@ deps-vultr: deps-common
 	$(PACKER) init packer/config.pkr.hcl
 	$(PACKER) init packer/vultr/config.pkr.hcl
 
+## --------------------------------------
+## Packer Configuration
+## --------------------------------------
+
+.PHONY: set-ssh-password
+set-ssh-password:
+	hack/set-ssh-password.sh
 
 ## --------------------------------------
 ## Container variables
@@ -425,37 +440,37 @@ VULTR_BUILD_TARGETS 	:= $(addprefix build-,$(VULTR_BUILD_NAMES))
 VULTR_VALIDATE_TARGETS 	:= $(addprefix validate-,$(VULTR_BUILD_NAMES))
 
 .PHONY: $(NODE_OVA_LOCAL_BUILD_TARGETS)
-$(NODE_OVA_LOCAL_BUILD_TARGETS): deps-ova
+$(NODE_OVA_LOCAL_BUILD_TARGETS): deps-ova set-ssh-password
     # This uses a packer file builder to input unattend variables into a JSON file to be consumed by the python script before running the vmware-iso provisioner
 	$(if $(findstring windows,$@),$(PACKER) build $(PACKER_WINDOWS_NODE_FLAGS) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-local-,,$@).json)" -only=file $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-windows.json,)
 	$(if $(findstring windows,$@),hack/windows-ova-unattend.py --unattend-file='./packer/ova/windows/$(subst build-node-ova-local-,,$@)/autounattend.xml',)
 	$(PACKER) build $(if $(findstring windows,$@),$(PACKER_WINDOWS_NODE_FLAGS),$(PACKER_NODE_FLAGS)) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-local-,,$@).json)" -except=vsphere -only=vmware-iso $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-$(if $(findstring windows,$@),windows,node).json
 
 .PHONY: $(NODE_OVA_LOCAL_VALIDATE_TARGETS)
-$(NODE_OVA_LOCAL_VALIDATE_TARGETS): deps-ova
+$(NODE_OVA_LOCAL_VALIDATE_TARGETS): deps-ova set-ssh-password
 	$(PACKER) validate $(if $(findstring windows,$@),$(PACKER_WINDOWS_NODE_FLAGS),$(PACKER_NODE_FLAGS)) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst validate-node-ova-local-,,$@).json)" -except=vsphere -only=vmware-iso $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-$(if $(findstring windows,$@),windows,node).json
 
 .PHONY: $(NODE_OVA_LOCAL_VMX_BUILD_TARGETS)
-$(NODE_OVA_LOCAL_VMX_BUILD_TARGETS): deps-ova
+$(NODE_OVA_LOCAL_VMX_BUILD_TARGETS): deps-ova set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-local-vmx-,,$@).json)" -var-file="packer/ova/vmx.json" -except=vsphere -except=vmware-iso -only=vmware-vmx $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-node.json
 
 .PHONY: $(NODE_OVA_LOCAL_BASE_BUILD_TARGETS)
-$(NODE_OVA_LOCAL_BASE_BUILD_TARGETS): deps-ova
+$(NODE_OVA_LOCAL_BASE_BUILD_TARGETS): deps-ova set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-local-base-,,$@).json)"  -except=vsphere -except=vmware-iso -except=vmware-vmx -only=vmware-iso-base $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-node.json
 
 .PHONY: $(NODE_OVA_VSPHERE_BUILD_TARGETS)
-$(NODE_OVA_VSPHERE_BUILD_TARGETS): deps-ova
+$(NODE_OVA_VSPHERE_BUILD_TARGETS): deps-ova set-ssh-password
     # This uses a packer file builder to input unattend variables into a JSON file to be consumed by the python script before running the vsphere provisioner
 	$(if $(findstring windows,$@),$(PACKER) build $(PACKER_WINDOWS_NODE_FLAGS) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-vsphere-,,$@).json)" -only=file $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-windows.json,)
 	$(if $(findstring windows,$@),hack/windows-ova-unattend.py --unattend-file='./packer/ova/windows/$(subst build-node-ova-vsphere-,,$@)/autounattend.xml',)
 	$(PACKER) build $(if $(findstring windows,$@),$(PACKER_WINDOWS_NODE_FLAGS),$(PACKER_NODE_FLAGS))  -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-vsphere-,,$@).json)" -var-file="packer/ova/vsphere.json"  -except=local -only=vsphere-iso $(ABSOLUTE_PACKER_VAR_FILES) -only=vsphere packer/ova/packer-$(if $(findstring windows,$@),windows,node).json
 
 .PHONY: $(NODE_OVA_VSPHERE_BASE_BUILD_TARGETS)
-$(NODE_OVA_VSPHERE_BASE_BUILD_TARGETS): deps-ova
+$(NODE_OVA_VSPHERE_BASE_BUILD_TARGETS): deps-ova set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-vsphere-base-,,$@).json)" -var-file="packer/ova/vsphere.json" -except=local -except=manifest -except=vsphere -only=vsphere-iso-base $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-node.json
 
 .PHONY: $(NODE_OVA_VSPHERE_CLONE_BUILD_TARGETS)
-$(NODE_OVA_VSPHERE_CLONE_BUILD_TARGETS): deps-ova
+$(NODE_OVA_VSPHERE_CLONE_BUILD_TARGETS): deps-ova set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="packer/ova/packer-common.json" -var-file="$(abspath packer/ova/$(subst build-node-ova-vsphere-clone-,,$@).json)" -var-file="packer/ova/vsphere.json" -except=local -only=vsphere-clone $(ABSOLUTE_PACKER_VAR_FILES) packer/ova/packer-node.json
 
 .PHONY: $(AMI_BUILD_TARGETS)
@@ -523,27 +538,27 @@ $(OPENSTACK_VALIDATE_TARGETS): deps-openstack
 	packer validate $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/openstack/$(subst validate-openstack-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/openstack/packer.json
 
 .PHONY: $(QEMU_BUILD_TARGETS)
-$(QEMU_BUILD_TARGETS): deps-qemu
+$(QEMU_BUILD_TARGETS): deps-qemu set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/qemu/$(subst build-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/qemu/packer.json
 
 .PHONY: $(QEMU_VALIDATE_TARGETS)
-$(QEMU_VALIDATE_TARGETS): deps-qemu
+$(QEMU_VALIDATE_TARGETS): deps-qemu set-ssh-password
 	$(PACKER) validate $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/qemu/$(subst validate-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/qemu/packer.json
 
 .PHONY: $(QEMU_KUBEVIRT_BUILD_TARGETS)
-$(QEMU_KUBEVIRT_BUILD_TARGETS): deps-qemu
+$(QEMU_KUBEVIRT_BUILD_TARGETS): deps-qemu set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/qemu/$(subst build-kubevirt-,,$@).json)" --var 'kubevirt=true' $(ABSOLUTE_PACKER_VAR_FILES) packer/qemu/packer.json
 
 .PHONY: $(QEMU_KUBEVIRT_VALIDATE_TARGETS)
-$(QEMU_KUBEVIRT_VALIDATE_TARGETS): deps-qemu
+$(QEMU_KUBEVIRT_VALIDATE_TARGETS): deps-qemu set-ssh-password
 	$(PACKER) validate $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/qemu/$(subst validate-kubevirt-,,$@).json)" --var 'kubevirt=true' $(ABSOLUTE_PACKER_VAR_FILES) packer/qemu/packer.json
 
 .PHONY: $(RAW_BUILD_TARGETS)
-$(RAW_BUILD_TARGETS): deps-raw
+$(RAW_BUILD_TARGETS): deps-raw set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/raw/$(subst build-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/raw/packer.json
 
 .PHONY: $(RAW_VALIDATE_TARGETS)
-$(RAW_VALIDATE_TARGETS): deps-raw
+$(RAW_VALIDATE_TARGETS): deps-raw set-ssh-password
 	$(PACKER) validate $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/raw/$(subst validate-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/raw/packer.json
 
 .PHONY: $(OCI_BUILD_TARGETS)
@@ -573,11 +588,14 @@ $(POWERVS_VALIDATE_TARGETS): deps-powervs
 	$(PACKER) validate $(PACKER_POWERVS_NODE_FLAGS) -var-file="$(abspath packer/powervs/$(subst validate-powervs-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) -except=flatcar packer/powervs/packer.json
 
 .PHONY: $(NUTANIX_BUILD_TARGETS)
-$(NUTANIX_BUILD_TARGETS): deps-nutanix
+$(NUTANIX_BUILD_TARGETS): deps-nutanix set-ssh-password
+	$(eval NUTANIX_USERDATA:=$(shell cat $(abspath packer/nutanix/linux/cloud-init/$(subst -,/,$(if $(findstring ubuntu,$@),$(call GET_UBUNTU_DOTTED_SEMVER,$(subst build-nutanix-,,$@)),$(subst build-nutanix-,,$@)))/user-data) | base64 -w0))
+	$(eval NUTANIX_VAR_FILE:=$(abspath packer/nutanix/$(subst build-nutanix-,,$@).json))
+	jq '.user_data = "$(NUTANIX_USERDATA)"' $(NUTANIX_VAR_FILE) > $(NUTANIX_VAR_FILE).templated && mv $(NUTANIX_VAR_FILE).templated $(NUTANIX_VAR_FILE)
 	$(PACKER) build $(if $(findstring windows,$@),$(PACKER_WINDOWS_NODE_FLAGS),$(PACKER_NODE_FLAGS)) -var-file="packer/nutanix/nutanix.json" -var-file="$(abspath packer/nutanix/$(subst build-nutanix-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/nutanix/packer$(if $(findstring windows,$@),-windows,).json
 
 .PHONY: $(NUTANIX_VALIDATE_TARGETS)
-$(NUTANIX_VALIDATE_TARGETS): deps-nutanix
+$(NUTANIX_VALIDATE_TARGETS): deps-nutanix set-ssh-password
 	$(PACKER) validate $(if $(findstring windows,$@),$(PACKER_WINDOWS_NODE_FLAGS),$(PACKER_NODE_FLAGS)) -var-file="packer/nutanix/nutanix.json" -var-file="$(abspath packer/nutanix/$(subst validate-nutanix-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/nutanix/packer$(if $(findstring windows,$@),-windows,).json
 
 .PHONY: $(HCLOUD_BUILD_TARGETS)
@@ -589,11 +607,11 @@ $(HCLOUD_VALIDATE_TARGETS): deps-hcloud
 	$(PACKER) validate $(PACKER_NODE_FLAGS) -var-file="packer/hcloud/hcloud-config.json" -var-file="$(abspath packer/hcloud/$(subst validate-hcloud-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/hcloud/packer$(if $(findstring flatcar,$@),-flatcar,).json
 
 .PHONY: $(PROXMOX_BUILD_TARGETS)
-$(PROXMOX_BUILD_TARGETS): deps-proxmox
+$(PROXMOX_BUILD_TARGETS): deps-proxmox set-ssh-password
 	$(PACKER) build $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/proxmox/$(subst build-proxmox-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/proxmox/packer.json
 
 .PHONY: $(PROXMOX_VALIDATE_TARGETS)
-$(PROXMOX_VALIDATE_TARGETS): deps-proxmox
+$(PROXMOX_VALIDATE_TARGETS): deps-proxmox set-ssh-password
 	$(PACKER) validate $(PACKER_NODE_FLAGS) -var-file="$(abspath packer/proxmox/$(subst validate-proxmox-,,$@).json)" $(ABSOLUTE_PACKER_VAR_FILES) packer/proxmox/packer.json
 
 .PHONY: $(VULTR_BUILD_TARGETS)
diff --git a/images/capi/hack/set-ssh-password.sh b/images/capi/hack/set-ssh-password.sh
new file mode 100755
index 000000000..2e99b649a
--- /dev/null
+++ b/images/capi/hack/set-ssh-password.sh
@@ -0,0 +1,49 @@
+#!/usr/bin/env bash
+
+# Copyright 2024 The Kubernetes Authors.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+set -o errexit
+set -o nounset
+set -o pipefail
+
+PACKER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../packer" && pwd -P)"
+
+openssl_binary=openssl11
+if ! command -v $openssl_binary >/dev/null 2>&1; then
+  openssl_binary=openssl
+  if ! command -v $openssl_binary >/dev/null 2>&1; then
+    echo "openssl or openssl11 binary must be in \$PATH" 1>&2
+    exit 1
+  fi
+fi
+
+# Check if openssl version is atleast 1.1.1 to support SHA-512 algorithm
+current_openssl_version=$($openssl_binary version | grep -Po "\d.\d.\d" | head -n1)
+minimum_openssl_version="1.1.1"
+if ! [ "$(printf '%s\n' "$minimum_openssl_version" "$current_openssl_version" | sort -V | head -n1)" = "$minimum_openssl_version" ]; then
+  echo "OpenSSL version must be atleast $minimum_openssl_version, current OpenSSL version is $current_openssl_version" 1>&2
+  exit 1
+fi
+
+export SSH_PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16; echo)
+SALT=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16; echo)
+export ENCRYPTED_SSH_PASSWORD=$($openssl_binary passwd -6 -salt $SALT -stdin <<< $SSH_PASSWORD)
+
+for file in $(find $PACKER_DIR -type f -name "*.tmpl"); do
+  if [ -f "${file%.*}" ]; then
+    rm ${file%.*}
+  fi
+  sed -e "s|\$SSH_PASSWORD|$SSH_PASSWORD|g" -e "s|\$ENCRYPTED_SSH_PASSWORD|$ENCRYPTED_SSH_PASSWORD|g" $file | tee ${file%.*}
+done
diff --git a/images/capi/packer/nutanix/.gitignore b/images/capi/packer/nutanix/.gitignore
new file mode 100644
index 000000000..472e2ad25
--- /dev/null
+++ b/images/capi/packer/nutanix/.gitignore
@@ -0,0 +1,2 @@
+packer.json
+user-data
diff --git a/images/capi/packer/nutanix/linux/cloud-init/rhel/8/user-data.tmpl b/images/capi/packer/nutanix/linux/cloud-init/rhel/8/user-data.tmpl
new file mode 100644
index 000000000..246b32e0e
--- /dev/null
+++ b/images/capi/packer/nutanix/linux/cloud-init/rhel/8/user-data.tmpl
@@ -0,0 +1,9 @@
+#cloud-config
+users:
+  - name: builder
+    sudo: ['ALL=(ALL) NOPASSWD:ALL']
+chpasswd:
+  list: |
+    builder:$SSH_PASSWORD
+  expire: False
+ssh_pwauth: True
\ No newline at end of file
diff --git a/images/capi/packer/nutanix/linux/cloud-init/rhel/9/user-data.tmpl b/images/capi/packer/nutanix/linux/cloud-init/rhel/9/user-data.tmpl
new file mode 100644
index 000000000..246b32e0e
--- /dev/null
+++ b/images/capi/packer/nutanix/linux/cloud-init/rhel/9/user-data.tmpl
@@ -0,0 +1,9 @@
+#cloud-config
+users:
+  - name: builder
+    sudo: ['ALL=(ALL) NOPASSWD:ALL']
+chpasswd:
+  list: |
+    builder:$SSH_PASSWORD
+  expire: False
+ssh_pwauth: True
\ No newline at end of file
diff --git a/images/capi/packer/nutanix/linux/cloud-init/rockylinux/8/user-data.tmpl b/images/capi/packer/nutanix/linux/cloud-init/rockylinux/8/user-data.tmpl
new file mode 100644
index 000000000..246b32e0e
--- /dev/null
+++ b/images/capi/packer/nutanix/linux/cloud-init/rockylinux/8/user-data.tmpl
@@ -0,0 +1,9 @@
+#cloud-config
+users:
+  - name: builder
+    sudo: ['ALL=(ALL) NOPASSWD:ALL']
+chpasswd:
+  list: |
+    builder:$SSH_PASSWORD
+  expire: False
+ssh_pwauth: True
\ No newline at end of file
diff --git a/images/capi/packer/nutanix/linux/cloud-init/rockylinux/9/user-data.tmpl b/images/capi/packer/nutanix/linux/cloud-init/rockylinux/9/user-data.tmpl
new file mode 100644
index 000000000..246b32e0e
--- /dev/null
+++ b/images/capi/packer/nutanix/linux/cloud-init/rockylinux/9/user-data.tmpl
@@ -0,0 +1,9 @@
+#cloud-config
+users:
+  - name: builder
+    sudo: ['ALL=(ALL) NOPASSWD:ALL']
+chpasswd:
+  list: |
+    builder:$SSH_PASSWORD
+  expire: False
+ssh_pwauth: True
\ No newline at end of file
diff --git a/images/capi/packer/nutanix/linux/cloud-init/ubuntu/20.04/user-data.tmpl b/images/capi/packer/nutanix/linux/cloud-init/ubuntu/20.04/user-data.tmpl
new file mode 100644
index 000000000..19398424d
--- /dev/null
+++ b/images/capi/packer/nutanix/linux/cloud-init/ubuntu/20.04/user-data.tmpl
@@ -0,0 +1,10 @@
+#cloud-config
+users:
+  - name: builder
+    sudo: ['ALL=(ALL) NOPASSWD:ALL']
+    shell: /bin/bash
+chpasswd:
+  list: |
+    builder:$SSH_PASSWORD
+  expire: False
+ssh_pwauth: True
\ No newline at end of file
diff --git a/images/capi/packer/nutanix/linux/cloud-init/ubuntu/22.04/user-data.tmpl b/images/capi/packer/nutanix/linux/cloud-init/ubuntu/22.04/user-data.tmpl
new file mode 100644
index 000000000..19398424d
--- /dev/null
+++ b/images/capi/packer/nutanix/linux/cloud-init/ubuntu/22.04/user-data.tmpl
@@ -0,0 +1,10 @@
+#cloud-config
+users:
+  - name: builder
+    sudo: ['ALL=(ALL) NOPASSWD:ALL']
+    shell: /bin/bash
+chpasswd:
+  list: |
+    builder:$SSH_PASSWORD
+  expire: False
+ssh_pwauth: True
\ No newline at end of file
diff --git a/images/capi/packer/nutanix/linux/cloud-init/ubuntu/24.04/user-data.tmpl b/images/capi/packer/nutanix/linux/cloud-init/ubuntu/24.04/user-data.tmpl
new file mode 100644
index 000000000..19398424d
--- /dev/null
+++ b/images/capi/packer/nutanix/linux/cloud-init/ubuntu/24.04/user-data.tmpl
@@ -0,0 +1,10 @@
+#cloud-config
+users:
+  - name: builder
+    sudo: ['ALL=(ALL) NOPASSWD:ALL']
+    shell: /bin/bash
+chpasswd:
+  list: |
+    builder:$SSH_PASSWORD
+  expire: False
+ssh_pwauth: True
\ No newline at end of file
diff --git a/images/capi/packer/nutanix/packer.json b/images/capi/packer/nutanix/packer.json.tmpl
similarity index 99%
rename from images/capi/packer/nutanix/packer.json
rename to images/capi/packer/nutanix/packer.json.tmpl
index cb733a8b7..c5e150dbd 100644
--- a/images/capi/packer/nutanix/packer.json
+++ b/images/capi/packer/nutanix/packer.json.tmpl
@@ -163,7 +163,7 @@
     "scp_extra_vars": "",
     "source_image_delete": "false",
     "source_image_force": "false",
-    "ssh_password": "{{ uuid }}",
+    "ssh_password": "$SSH_PASSWORD",
     "ssh_username": "builder",
     "vm_force_delete": "true"
   }
diff --git a/images/capi/packer/ova/.gitignore b/images/capi/packer/ova/.gitignore
new file mode 100644
index 000000000..1bbf6f817
--- /dev/null
+++ b/images/capi/packer/ova/.gitignore
@@ -0,0 +1,6 @@
+packer-common.json
+ks.cfg
+ks.json
+preseed.cfg
+preseed-efi.cfg
+user-data
diff --git a/images/capi/packer/ova/linux/rhel/http/7/ks.cfg b/images/capi/packer/ova/linux/centos/http/7/ks.cfg.tmpl
similarity index 96%
rename from images/capi/packer/ova/linux/rhel/http/7/ks.cfg
rename to images/capi/packer/ova/linux/centos/http/7/ks.cfg.tmpl
index 305336268..39b7211c0 100644
--- a/images/capi/packer/ova/linux/rhel/http/7/ks.cfg
+++ b/images/capi/packer/ova/linux/centos/http/7/ks.cfg.tmpl
@@ -37,7 +37,7 @@ unsupported_hardware
 
 # Configure the user(s)
 auth --enableshadow --passalgo=sha512 --kickstart
-user --name=builder --plaintext --password builder --groups=builder,wheel
+user --name=builder --plaintext --password $SSH_PASSWORD --groups=builder,wheel
 
 # Disable general install minutia
 firstboot --disabled
diff --git a/images/capi/packer/ova/linux/centos/http/8/ks.cfg b/images/capi/packer/ova/linux/centos/http/8/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/ova/linux/centos/http/8/ks.cfg
rename to images/capi/packer/ova/linux/centos/http/8/ks.cfg.tmpl
index 59700d72a..5607fa080 100644
--- a/images/capi/packer/ova/linux/centos/http/8/ks.cfg
+++ b/images/capi/packer/ova/linux/centos/http/8/ks.cfg.tmpl
@@ -26,7 +26,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/ova/linux/photon/http/4/ks.json b/images/capi/packer/ova/linux/photon/http/3/ks.json.tmpl
similarity index 96%
rename from images/capi/packer/ova/linux/photon/http/4/ks.json
rename to images/capi/packer/ova/linux/photon/http/3/ks.json.tmpl
index 4b03b10fd..e95c2bf1d 100644
--- a/images/capi/packer/ova/linux/photon/http/4/ks.json
+++ b/images/capi/packer/ova/linux/photon/http/3/ks.json.tmpl
@@ -49,7 +49,7 @@
   },
   "postinstall": [
     "#!/bin/sh",
-    "useradd -U -d /home/builder -m --groups wheel builder && echo 'builder:builder' | chpasswd",
+    "useradd -U -d /home/builder -m --groups wheel builder && echo 'builder:$SSH_PASSWORD' | chpasswd",
     "echo 'builder ALL=(ALL) NOPASSWD: ALL' >/etc/sudoers.d/builder",
     "chmod 440 /etc/sudoers.d/builder",
     "systemctl enable sshd",
diff --git a/images/capi/packer/ova/linux/photon/http/3/ks.json b/images/capi/packer/ova/linux/photon/http/4/ks.json.tmpl
similarity index 96%
rename from images/capi/packer/ova/linux/photon/http/3/ks.json
rename to images/capi/packer/ova/linux/photon/http/4/ks.json.tmpl
index 4b03b10fd..e95c2bf1d 100644
--- a/images/capi/packer/ova/linux/photon/http/3/ks.json
+++ b/images/capi/packer/ova/linux/photon/http/4/ks.json.tmpl
@@ -49,7 +49,7 @@
   },
   "postinstall": [
     "#!/bin/sh",
-    "useradd -U -d /home/builder -m --groups wheel builder && echo 'builder:builder' | chpasswd",
+    "useradd -U -d /home/builder -m --groups wheel builder && echo 'builder:$SSH_PASSWORD' | chpasswd",
     "echo 'builder ALL=(ALL) NOPASSWD: ALL' >/etc/sudoers.d/builder",
     "chmod 440 /etc/sudoers.d/builder",
     "systemctl enable sshd",
diff --git a/images/capi/packer/ova/linux/photon/http/5/ks.json b/images/capi/packer/ova/linux/photon/http/5/ks.json.tmpl
similarity index 96%
rename from images/capi/packer/ova/linux/photon/http/5/ks.json
rename to images/capi/packer/ova/linux/photon/http/5/ks.json.tmpl
index fe9497af0..f2cfd6a7f 100644
--- a/images/capi/packer/ova/linux/photon/http/5/ks.json
+++ b/images/capi/packer/ova/linux/photon/http/5/ks.json.tmpl
@@ -47,7 +47,7 @@
   },
   "postinstall": [
     "#!/bin/sh",
-    "useradd -U -d /home/builder -m --groups wheel builder && echo 'builder:builder' | chpasswd",
+    "useradd -U -d /home/builder -m --groups wheel builder && echo 'builder:$SSH_PASSWORD' | chpasswd",
     "echo 'builder ALL=(ALL) NOPASSWD: ALL' >/etc/sudoers.d/builder",
     "chmod 440 /etc/sudoers.d/builder",
     "systemctl enable sshd",
diff --git a/images/capi/packer/ova/linux/centos/http/7/ks.cfg b/images/capi/packer/ova/linux/rhel/http/7/ks.cfg.tmpl
similarity index 96%
rename from images/capi/packer/ova/linux/centos/http/7/ks.cfg
rename to images/capi/packer/ova/linux/rhel/http/7/ks.cfg.tmpl
index 305336268..39b7211c0 100644
--- a/images/capi/packer/ova/linux/centos/http/7/ks.cfg
+++ b/images/capi/packer/ova/linux/rhel/http/7/ks.cfg.tmpl
@@ -37,7 +37,7 @@ unsupported_hardware
 
 # Configure the user(s)
 auth --enableshadow --passalgo=sha512 --kickstart
-user --name=builder --plaintext --password builder --groups=builder,wheel
+user --name=builder --plaintext --password $SSH_PASSWORD --groups=builder,wheel
 
 # Disable general install minutia
 firstboot --disabled
diff --git a/images/capi/packer/ova/linux/rhel/http/8/ks.cfg b/images/capi/packer/ova/linux/rhel/http/8/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/ova/linux/rhel/http/8/ks.cfg
rename to images/capi/packer/ova/linux/rhel/http/8/ks.cfg.tmpl
index 59700d72a..5607fa080 100644
--- a/images/capi/packer/ova/linux/rhel/http/8/ks.cfg
+++ b/images/capi/packer/ova/linux/rhel/http/8/ks.cfg.tmpl
@@ -26,7 +26,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/ova/linux/rhel/http/9/ks.cfg b/images/capi/packer/ova/linux/rhel/http/9/ks.cfg.tmpl
similarity index 94%
rename from images/capi/packer/ova/linux/rhel/http/9/ks.cfg
rename to images/capi/packer/ova/linux/rhel/http/9/ks.cfg.tmpl
index bce2d10db..cc13d548d 100644
--- a/images/capi/packer/ova/linux/rhel/http/9/ks.cfg
+++ b/images/capi/packer/ova/linux/rhel/http/9/ks.cfg.tmpl
@@ -22,7 +22,7 @@ network --bootproto=dhcp --onboot=on --ipv6=auto --activate --hostname=rhel9
 rootpw --lock
 
 # Create builder user
-user --name=builder --groups=wheel --password=builder --plaintext --shell=/bin/bash
+user --name=builder --groups=wheel --password=$SSH_PASSWORD --plaintext --shell=/bin/bash
 
 # System services
 selinux --permissive
diff --git a/images/capi/packer/ova/linux/rockylinux/http/8/ks.cfg b/images/capi/packer/ova/linux/rockylinux/http/8/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/ova/linux/rockylinux/http/8/ks.cfg
rename to images/capi/packer/ova/linux/rockylinux/http/8/ks.cfg.tmpl
index 55b5d99ad..61c9f8075 100644
--- a/images/capi/packer/ova/linux/rockylinux/http/8/ks.cfg
+++ b/images/capi/packer/ova/linux/rockylinux/http/8/ks.cfg.tmpl
@@ -22,7 +22,7 @@ network --bootproto=dhcp --onboot=on --ipv6=auto --activate --hostname=capv.vm
 rootpw --lock
 
 # Create builder user
-user --name=builder --groups=wheel --password=builder --plaintext --shell=/bin/bash
+user --name=builder --groups=wheel --password=$SSH_PASSWORD --plaintext --shell=/bin/bash
 
 # System services
 selinux --permissive
diff --git a/images/capi/packer/ova/linux/rockylinux/http/9/ks.cfg b/images/capi/packer/ova/linux/rockylinux/http/9/ks.cfg.tmpl
similarity index 94%
rename from images/capi/packer/ova/linux/rockylinux/http/9/ks.cfg
rename to images/capi/packer/ova/linux/rockylinux/http/9/ks.cfg.tmpl
index 96ad1eb08..34c91bdd8 100644
--- a/images/capi/packer/ova/linux/rockylinux/http/9/ks.cfg
+++ b/images/capi/packer/ova/linux/rockylinux/http/9/ks.cfg.tmpl
@@ -22,7 +22,7 @@ network --bootproto=dhcp --onboot=on --ipv6=auto --activate --hostname=capv.vm
 rootpw --lock
 
 # Create builder user
-user --name=builder --groups=wheel --password=builder --plaintext --shell=/bin/bash
+user --name=builder --groups=wheel --password=$SSH_PASSWORD --plaintext --shell=/bin/bash
 
 # System services
 selinux --permissive
diff --git a/images/capi/packer/ova/linux/ubuntu/http/22.04.efi/user-data b/images/capi/packer/ova/linux/ubuntu/http/22.04.efi/user-data.tmpl
similarity index 95%
rename from images/capi/packer/ova/linux/ubuntu/http/22.04.efi/user-data
rename to images/capi/packer/ova/linux/ubuntu/http/22.04.efi/user-data.tmpl
index 095d9cef3..3ddbf78be 100644
--- a/images/capi/packer/ova/linux/ubuntu/http/22.04.efi/user-data
+++ b/images/capi/packer/ova/linux/ubuntu/http/22.04.efi/user-data.tmpl
@@ -90,8 +90,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/ova/linux/ubuntu/http/22.04/user-data b/images/capi/packer/ova/linux/ubuntu/http/22.04/user-data.tmpl
similarity index 95%
rename from images/capi/packer/ova/linux/ubuntu/http/22.04/user-data
rename to images/capi/packer/ova/linux/ubuntu/http/22.04/user-data.tmpl
index fdcb56c26..552fab33e 100644
--- a/images/capi/packer/ova/linux/ubuntu/http/22.04/user-data
+++ b/images/capi/packer/ova/linux/ubuntu/http/22.04/user-data.tmpl
@@ -70,8 +70,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/ova/linux/ubuntu/http/24.04.efi/user-data b/images/capi/packer/ova/linux/ubuntu/http/24.04.efi/user-data.tmpl
similarity index 95%
rename from images/capi/packer/ova/linux/ubuntu/http/24.04.efi/user-data
rename to images/capi/packer/ova/linux/ubuntu/http/24.04.efi/user-data.tmpl
index 4fc719c5e..d2dfa8cdc 100644
--- a/images/capi/packer/ova/linux/ubuntu/http/24.04.efi/user-data
+++ b/images/capi/packer/ova/linux/ubuntu/http/24.04.efi/user-data.tmpl
@@ -90,8 +90,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/ova/linux/ubuntu/http/24.04/user-data b/images/capi/packer/ova/linux/ubuntu/http/24.04/user-data.tmpl
similarity index 95%
rename from images/capi/packer/ova/linux/ubuntu/http/24.04/user-data
rename to images/capi/packer/ova/linux/ubuntu/http/24.04/user-data.tmpl
index 4de39804a..35b601024 100644
--- a/images/capi/packer/ova/linux/ubuntu/http/24.04/user-data
+++ b/images/capi/packer/ova/linux/ubuntu/http/24.04/user-data.tmpl
@@ -70,8 +70,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/ova/linux/ubuntu/http/base/preseed-efi.cfg b/images/capi/packer/ova/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
similarity index 97%
rename from images/capi/packer/ova/linux/ubuntu/http/base/preseed-efi.cfg
rename to images/capi/packer/ova/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
index 68412263f..7703149d4 100644
--- a/images/capi/packer/ova/linux/ubuntu/http/base/preseed-efi.cfg
+++ b/images/capi/packer/ova/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
@@ -81,8 +81,8 @@ d-i partman/confirm_nooverwrite boolean true
 # Create the default user.
 d-i passwd/user-fullname string builder
 d-i passwd/username string builder
-d-i passwd/user-password password builder
-d-i passwd/user-password-again password builder
+d-i passwd/user-password password $SSH_PASSWORD
+d-i passwd/user-password-again password $SSH_PASSWORD
 d-i user-setup/encrypt-home boolean false
 d-i user-setup/allow-password-weak boolean true
 
diff --git a/images/capi/packer/ova/linux/ubuntu/http/base/preseed.cfg b/images/capi/packer/ova/linux/ubuntu/http/base/preseed.cfg.tmpl
similarity index 98%
rename from images/capi/packer/ova/linux/ubuntu/http/base/preseed.cfg
rename to images/capi/packer/ova/linux/ubuntu/http/base/preseed.cfg.tmpl
index f6e5d428e..cf75c8971 100644
--- a/images/capi/packer/ova/linux/ubuntu/http/base/preseed.cfg
+++ b/images/capi/packer/ova/linux/ubuntu/http/base/preseed.cfg.tmpl
@@ -79,8 +79,8 @@ d-i partman-efi/non_efi_system boolean false
 # Create the default user.
 d-i passwd/user-fullname string builder
 d-i passwd/username string builder
-d-i passwd/user-password password builder
-d-i passwd/user-password-again password builder
+d-i passwd/user-password password $SSH_PASSWORD
+d-i passwd/user-password-again password $SSH_PASSWORD
 d-i user-setup/encrypt-home boolean false
 d-i user-setup/allow-password-weak boolean true
 
diff --git a/images/capi/packer/ova/packer-common.json b/images/capi/packer/ova/packer-common.json.tmpl
similarity index 96%
rename from images/capi/packer/ova/packer-common.json
rename to images/capi/packer/ova/packer-common.json.tmpl
index 23c4539ec..16ea36819 100644
--- a/images/capi/packer/ova/packer-common.json
+++ b/images/capi/packer/ova/packer-common.json.tmpl
@@ -24,7 +24,7 @@
   "remote_username": "",
   "skip_compaction": "false",
   "ssh_handshake_attempts": "100",
-  "ssh_password": "{{ uuid }}",
+  "ssh_password": "$SSH_PASSWORD",
   "ssh_proxy_host": "",
   "ssh_proxy_port": "",
   "ssh_timeout": "40m",
diff --git a/images/capi/packer/proxmox/.gitignore b/images/capi/packer/proxmox/.gitignore
new file mode 100644
index 000000000..eb04df5fb
--- /dev/null
+++ b/images/capi/packer/proxmox/.gitignore
@@ -0,0 +1,3 @@
+packer.json
+ks.cfg
+user-data
diff --git a/images/capi/packer/proxmox/linux/rockylinux/http/9/ks.cfg b/images/capi/packer/proxmox/linux/rockylinux/http/9/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/proxmox/linux/rockylinux/http/9/ks.cfg
rename to images/capi/packer/proxmox/linux/rockylinux/http/9/ks.cfg.tmpl
index 240bc2c44..f5bd9075e 100644
--- a/images/capi/packer/proxmox/linux/rockylinux/http/9/ks.cfg
+++ b/images/capi/packer/proxmox/linux/rockylinux/http/9/ks.cfg.tmpl
@@ -22,7 +22,7 @@ network --bootproto=dhcp --onboot=on --ipv6=auto --activate --hostname=capv.vm
 rootpw --lock
 
 # Create builder user
-user --name=builder --groups=wheel --password=builder --plaintext --shell=/bin/bash
+user --name=builder --groups=wheel --password=$SSH_PASSWORD --plaintext --shell=/bin/bash
 
 # System services
 selinux --permissive
diff --git a/images/capi/packer/proxmox/linux/ubuntu/http/22.04/user-data b/images/capi/packer/proxmox/linux/ubuntu/http/22.04/user-data.tmpl
similarity index 91%
rename from images/capi/packer/proxmox/linux/ubuntu/http/22.04/user-data
rename to images/capi/packer/proxmox/linux/ubuntu/http/22.04/user-data.tmpl
index 5092fe034..40d8c7076 100644
--- a/images/capi/packer/proxmox/linux/ubuntu/http/22.04/user-data
+++ b/images/capi/packer/proxmox/linux/ubuntu/http/22.04/user-data.tmpl
@@ -47,8 +47,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/proxmox/linux/ubuntu/http/24.04/user-data b/images/capi/packer/proxmox/linux/ubuntu/http/24.04/user-data.tmpl
similarity index 92%
rename from images/capi/packer/proxmox/linux/ubuntu/http/24.04/user-data
rename to images/capi/packer/proxmox/linux/ubuntu/http/24.04/user-data.tmpl
index 8af863154..d241348dc 100644
--- a/images/capi/packer/proxmox/linux/ubuntu/http/24.04/user-data
+++ b/images/capi/packer/proxmox/linux/ubuntu/http/24.04/user-data.tmpl
@@ -54,8 +54,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/proxmox/packer.json b/images/capi/packer/proxmox/packer.json.tmpl
similarity index 99%
rename from images/capi/packer/proxmox/packer.json
rename to images/capi/packer/proxmox/packer.json.tmpl
index fc119ef42..bb0bdc226 100644
--- a/images/capi/packer/proxmox/packer.json
+++ b/images/capi/packer/proxmox/packer.json.tmpl
@@ -200,7 +200,7 @@
     "node": "{{env `PROXMOX_NODE`}}",
     "proxmox_url": "{{env `PROXMOX_URL`}}",
     "sockets": "2",
-    "ssh_password": "{{ uuid }}",
+    "ssh_password": "$SSH_PASSWORD",
     "ssh_username": "builder",
     "storage_pool": "{{env `PROXMOX_STORAGE_POOL`}}",
     "storage_pool_type": "lvm",
diff --git a/images/capi/packer/qemu/.gitignore b/images/capi/packer/qemu/.gitignore
new file mode 100644
index 000000000..ed3058d85
--- /dev/null
+++ b/images/capi/packer/qemu/.gitignore
@@ -0,0 +1,5 @@
+packer.json
+ks.cfg
+preseed.cfg
+preseed-efi.cfg
+user-data
diff --git a/images/capi/packer/qemu/cloud-init/user-data b/images/capi/packer/qemu/cloud-init/user-data.tmpl
similarity index 63%
rename from images/capi/packer/qemu/cloud-init/user-data
rename to images/capi/packer/qemu/cloud-init/user-data.tmpl
index 0df503993..87883864b 100644
--- a/images/capi/packer/qemu/cloud-init/user-data
+++ b/images/capi/packer/qemu/cloud-init/user-data.tmpl
@@ -2,7 +2,7 @@
 ssh_pwauth: true
 users:
   - name: builder
-    passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+    passwd: $ENCYRPTED_SSH_PASSWORD
     groups: [adm, cdrom, dip, plugdev, lxd, sudo]
     lock-passwd: false
     sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/qemu/linux/centos/http/7/ks.cfg b/images/capi/packer/qemu/linux/centos/http/7/ks.cfg.tmpl
similarity index 96%
rename from images/capi/packer/qemu/linux/centos/http/7/ks.cfg
rename to images/capi/packer/qemu/linux/centos/http/7/ks.cfg.tmpl
index d26a3e0e7..b796cd6ab 100644
--- a/images/capi/packer/qemu/linux/centos/http/7/ks.cfg
+++ b/images/capi/packer/qemu/linux/centos/http/7/ks.cfg.tmpl
@@ -37,7 +37,7 @@ unsupported_hardware
 
 # Configure the user(s)
 auth --enableshadow --passalgo=sha512 --kickstart
-user --name=builder --plaintext --password builder --groups=builder,wheel
+user --name=builder --plaintext --password=$SSH_PASSWORD --groups=builder,wheel
 
 # Disable general install minutia
 firstboot --disabled
diff --git a/images/capi/packer/qemu/linux/rhel/http/8/ks.cfg b/images/capi/packer/qemu/linux/centos/http/8/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/rhel/http/8/ks.cfg
rename to images/capi/packer/qemu/linux/centos/http/8/ks.cfg.tmpl
index 096f9d8ab..6dfed5740 100644
--- a/images/capi/packer/qemu/linux/rhel/http/8/ks.cfg
+++ b/images/capi/packer/qemu/linux/centos/http/8/ks.cfg.tmpl
@@ -26,7 +26,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/qemu/linux/centos/http/9/ks.cfg b/images/capi/packer/qemu/linux/centos/http/9/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/centos/http/9/ks.cfg
rename to images/capi/packer/qemu/linux/centos/http/9/ks.cfg.tmpl
index c3c6b7e0b..d591ec761 100644
--- a/images/capi/packer/qemu/linux/centos/http/9/ks.cfg
+++ b/images/capi/packer/qemu/linux/centos/http/9/ks.cfg.tmpl
@@ -25,7 +25,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/qemu/linux/centos/http/8/ks.cfg b/images/capi/packer/qemu/linux/rhel/http/8/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/centos/http/8/ks.cfg
rename to images/capi/packer/qemu/linux/rhel/http/8/ks.cfg.tmpl
index 096f9d8ab..6dfed5740 100644
--- a/images/capi/packer/qemu/linux/centos/http/8/ks.cfg
+++ b/images/capi/packer/qemu/linux/rhel/http/8/ks.cfg.tmpl
@@ -26,7 +26,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/raw/linux/rhel/http/9/ks.cfg b/images/capi/packer/qemu/linux/rhel/http/9/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/raw/linux/rhel/http/9/ks.cfg
rename to images/capi/packer/qemu/linux/rhel/http/9/ks.cfg.tmpl
index c3c6b7e0b..d591ec761 100644
--- a/images/capi/packer/raw/linux/rhel/http/9/ks.cfg
+++ b/images/capi/packer/qemu/linux/rhel/http/9/ks.cfg.tmpl
@@ -25,7 +25,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/qemu/linux/rockylinux/http/8/ks.cfg b/images/capi/packer/qemu/linux/rockylinux/http/8/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/rockylinux/http/8/ks.cfg
rename to images/capi/packer/qemu/linux/rockylinux/http/8/ks.cfg.tmpl
index ac2b454e7..b8f8480f5 100644
--- a/images/capi/packer/qemu/linux/rockylinux/http/8/ks.cfg
+++ b/images/capi/packer/qemu/linux/rockylinux/http/8/ks.cfg.tmpl
@@ -22,7 +22,7 @@ network --bootproto=dhcp --onboot=on --ipv6=auto --activate --hostname=capv.vm
 rootpw --lock
 
 # Create builder user
-user --name=builder --groups=wheel --password=builder --plaintext --shell=/bin/bash
+user --name=builder --groups=wheel --password=$SSH_PASSWORD --plaintext --shell=/bin/bash
 
 # System services
 selinux --permissive
diff --git a/images/capi/packer/qemu/linux/rockylinux/http/9/ks.cfg b/images/capi/packer/qemu/linux/rockylinux/http/9/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/rockylinux/http/9/ks.cfg
rename to images/capi/packer/qemu/linux/rockylinux/http/9/ks.cfg.tmpl
index 96709b62d..964d5ab99 100644
--- a/images/capi/packer/qemu/linux/rockylinux/http/9/ks.cfg
+++ b/images/capi/packer/qemu/linux/rockylinux/http/9/ks.cfg.tmpl
@@ -22,7 +22,7 @@ network --bootproto=dhcp --onboot=on --ipv6=auto --activate --hostname=capv.vm
 rootpw --lock
 
 # Create builder user
-user --name=builder --groups=wheel --password=builder --plaintext --shell=/bin/bash
+user --name=builder --groups=wheel --password=$SSH_PASSWORD --plaintext --shell=/bin/bash
 
 # System services
 selinux --permissive
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi.qemu/user-data b/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi.qemu/user-data.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/ubuntu/http/22.04.efi.qemu/user-data
rename to images/capi/packer/qemu/linux/ubuntu/http/22.04.efi.qemu/user-data.tmpl
index adad49044..9183bbae5 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi.qemu/user-data
+++ b/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi.qemu/user-data.tmpl
@@ -83,8 +83,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi/user-data b/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi/user-data.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/ubuntu/http/22.04.efi/user-data
rename to images/capi/packer/qemu/linux/ubuntu/http/22.04.efi/user-data.tmpl
index 743abae99..4df289f37 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi/user-data
+++ b/images/capi/packer/qemu/linux/ubuntu/http/22.04.efi/user-data.tmpl
@@ -85,8 +85,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/22.04/user-data b/images/capi/packer/qemu/linux/ubuntu/http/22.04/user-data.tmpl
similarity index 94%
rename from images/capi/packer/qemu/linux/ubuntu/http/22.04/user-data
rename to images/capi/packer/qemu/linux/ubuntu/http/22.04/user-data.tmpl
index 3fe63c5fe..24ef485cd 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/22.04/user-data
+++ b/images/capi/packer/qemu/linux/ubuntu/http/22.04/user-data.tmpl
@@ -65,8 +65,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/24.04/user-data b/images/capi/packer/qemu/linux/ubuntu/http/23.04/user-data.tmpl
similarity index 94%
rename from images/capi/packer/qemu/linux/ubuntu/http/24.04/user-data
rename to images/capi/packer/qemu/linux/ubuntu/http/23.04/user-data.tmpl
index e6b1fc77a..11bcda99d 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/24.04/user-data
+++ b/images/capi/packer/qemu/linux/ubuntu/http/23.04/user-data.tmpl
@@ -72,8 +72,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/24.04.efi/user-data b/images/capi/packer/qemu/linux/ubuntu/http/24.04.efi/user-data.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/ubuntu/http/24.04.efi/user-data
rename to images/capi/packer/qemu/linux/ubuntu/http/24.04.efi/user-data.tmpl
index b1ad45b2b..94ee5dc05 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/24.04.efi/user-data
+++ b/images/capi/packer/qemu/linux/ubuntu/http/24.04.efi/user-data.tmpl
@@ -95,8 +95,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/23.04/user-data b/images/capi/packer/qemu/linux/ubuntu/http/24.04/user-data.tmpl
similarity index 94%
rename from images/capi/packer/qemu/linux/ubuntu/http/23.04/user-data
rename to images/capi/packer/qemu/linux/ubuntu/http/24.04/user-data.tmpl
index e6b1fc77a..11bcda99d 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/23.04/user-data
+++ b/images/capi/packer/qemu/linux/ubuntu/http/24.04/user-data.tmpl
@@ -72,8 +72,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/base/preseed-efi.cfg b/images/capi/packer/qemu/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
similarity index 97%
rename from images/capi/packer/qemu/linux/ubuntu/http/base/preseed-efi.cfg
rename to images/capi/packer/qemu/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
index 5078243d7..3d6597ca7 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/base/preseed-efi.cfg
+++ b/images/capi/packer/qemu/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
@@ -81,8 +81,8 @@ d-i partman/confirm_nooverwrite boolean true
 # Create the default user.
 d-i passwd/user-fullname string builder
 d-i passwd/username string builder
-d-i passwd/user-password password builder
-d-i passwd/user-password-again password builder
+d-i passwd/user-password password $SSH_PASSWORD
+d-i passwd/user-password-again password $SSH_PASSWORD
 d-i user-setup/encrypt-home boolean false
 d-i user-setup/allow-password-weak boolean true
 
diff --git a/images/capi/packer/qemu/linux/ubuntu/http/base/preseed.cfg b/images/capi/packer/qemu/linux/ubuntu/http/base/preseed.cfg.tmpl
similarity index 97%
rename from images/capi/packer/qemu/linux/ubuntu/http/base/preseed.cfg
rename to images/capi/packer/qemu/linux/ubuntu/http/base/preseed.cfg.tmpl
index 1f2dce575..8f90e1fe0 100644
--- a/images/capi/packer/qemu/linux/ubuntu/http/base/preseed.cfg
+++ b/images/capi/packer/qemu/linux/ubuntu/http/base/preseed.cfg.tmpl
@@ -79,8 +79,8 @@ d-i partman-efi/non_efi_system boolean false
 # Create the default user.
 d-i passwd/user-fullname string builder
 d-i passwd/username string builder
-d-i passwd/user-password password builder
-d-i passwd/user-password-again password builder
+d-i passwd/user-password password $SSH_PASSWORD
+d-i passwd/user-password-again password $SSH_PASSWORD
 d-i user-setup/encrypt-home boolean false
 d-i user-setup/allow-password-weak boolean true
 
diff --git a/images/capi/packer/qemu/packer.json b/images/capi/packer/qemu/packer.json.tmpl
similarity index 99%
rename from images/capi/packer/qemu/packer.json
rename to images/capi/packer/qemu/packer.json.tmpl
index 919f817fa..e53f3ac3f 100644
--- a/images/capi/packer/qemu/packer.json
+++ b/images/capi/packer/qemu/packer.json.tmpl
@@ -211,7 +211,7 @@
     "output_directory": "./output/{{user `build_name`}}-kube-{{user `kubernetes_semver`}}",
     "python_path": "",
     "qemu_binary": "qemu-system-x86_64",
-    "ssh_password": "{{ uuid }}",
+    "ssh_password": "$SSH_PASSWORD",
     "ssh_username": "builder",
     "vm_name": "{{user `build_name`}}-kube-{{user `kubernetes_semver`}}",
     "vnc_bind_address": "127.0.0.1"
diff --git a/images/capi/packer/raw/.gitignore b/images/capi/packer/raw/.gitignore
new file mode 100644
index 000000000..4a8abef2a
--- /dev/null
+++ b/images/capi/packer/raw/.gitignore
@@ -0,0 +1,5 @@
+packer.json
+ks.cfg
+ks-efi.cfg
+preseed.cfg
+preseed-efi.cfg
diff --git a/images/capi/packer/raw/linux/rhel/http/8/ks.cfg b/images/capi/packer/raw/linux/rhel/http/8/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/raw/linux/rhel/http/8/ks.cfg
rename to images/capi/packer/raw/linux/rhel/http/8/ks.cfg.tmpl
index 096f9d8ab..6dfed5740 100644
--- a/images/capi/packer/raw/linux/rhel/http/8/ks.cfg
+++ b/images/capi/packer/raw/linux/rhel/http/8/ks.cfg.tmpl
@@ -26,7 +26,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/raw/linux/rhel/http/9/ks-efi.cfg b/images/capi/packer/raw/linux/rhel/http/9/ks-efi.cfg.tmpl
similarity index 95%
rename from images/capi/packer/raw/linux/rhel/http/9/ks-efi.cfg
rename to images/capi/packer/raw/linux/rhel/http/9/ks-efi.cfg.tmpl
index c0d43792d..586c063a8 100644
--- a/images/capi/packer/raw/linux/rhel/http/9/ks-efi.cfg
+++ b/images/capi/packer/raw/linux/rhel/http/9/ks-efi.cfg.tmpl
@@ -25,7 +25,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/qemu/linux/rhel/http/9/ks.cfg b/images/capi/packer/raw/linux/rhel/http/9/ks.cfg.tmpl
similarity index 95%
rename from images/capi/packer/qemu/linux/rhel/http/9/ks.cfg
rename to images/capi/packer/raw/linux/rhel/http/9/ks.cfg.tmpl
index c3c6b7e0b..d591ec761 100644
--- a/images/capi/packer/qemu/linux/rhel/http/9/ks.cfg
+++ b/images/capi/packer/raw/linux/rhel/http/9/ks.cfg.tmpl
@@ -25,7 +25,7 @@ skipx
 # System timezone
 timezone UTC
 # Add a user named builder
-user --groups=wheel --name=builder --password=builder --plaintext --gecos="builder"
+user --groups=wheel --name=builder --password=$SSH_PASSWORD --plaintext --gecos="builder"
 
 # System bootloader configuration
 bootloader --location=mbr --boot-drive=sda
diff --git a/images/capi/packer/raw/linux/ubuntu/http/22.04.efi/user-data b/images/capi/packer/raw/linux/ubuntu/http/22.04.efi/user-data.tmpl
similarity index 95%
rename from images/capi/packer/raw/linux/ubuntu/http/22.04.efi/user-data
rename to images/capi/packer/raw/linux/ubuntu/http/22.04.efi/user-data.tmpl
index d14d0fa49..6aedd8389 100644
--- a/images/capi/packer/raw/linux/ubuntu/http/22.04.efi/user-data
+++ b/images/capi/packer/raw/linux/ubuntu/http/22.04.efi/user-data.tmpl
@@ -91,8 +91,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/raw/linux/ubuntu/http/22.04/user-data b/images/capi/packer/raw/linux/ubuntu/http/22.04/user-data.tmpl
similarity index 95%
rename from images/capi/packer/raw/linux/ubuntu/http/22.04/user-data
rename to images/capi/packer/raw/linux/ubuntu/http/22.04/user-data.tmpl
index a5ed32346..50a20ac13 100644
--- a/images/capi/packer/raw/linux/ubuntu/http/22.04/user-data
+++ b/images/capi/packer/raw/linux/ubuntu/http/22.04/user-data.tmpl
@@ -70,8 +70,8 @@ autoinstall:
   user-data:
     users:
       - name: builder
-        # openssl passwd -6 -stdin <<< builder
-        passwd: $6$xyz$UtXVazU08Q5b8AW.TJ3MPYZglyXa3Ttf2RCel8MCUPlEYO1evWxeWBhZ2QqivU/Ij4tqYAxMCqc2ujEM4dMSe1
+        # openssl passwd -6 -salt <random salt> -stdin <<< <SSH password>
+        passwd: $ENCYRPTED_SSH_PASSWORD
         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
         lock-passwd: false
         sudo: ALL=(ALL) NOPASSWD:ALL
diff --git a/images/capi/packer/raw/linux/ubuntu/http/base/preseed-efi.cfg b/images/capi/packer/raw/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
similarity index 97%
rename from images/capi/packer/raw/linux/ubuntu/http/base/preseed-efi.cfg
rename to images/capi/packer/raw/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
index 14cb4008f..3942f2529 100644
--- a/images/capi/packer/raw/linux/ubuntu/http/base/preseed-efi.cfg
+++ b/images/capi/packer/raw/linux/ubuntu/http/base/preseed-efi.cfg.tmpl
@@ -81,8 +81,8 @@ d-i partman/confirm_nooverwrite boolean true
 # Create the default user.
 d-i passwd/user-fullname string builder
 d-i passwd/username string builder
-d-i passwd/user-password password builder
-d-i passwd/user-password-again password builder
+d-i passwd/user-password password $SSH_PASSWORD
+d-i passwd/user-password-again password $SSH_PASSWORD
 d-i user-setup/encrypt-home boolean false
 d-i user-setup/allow-password-weak boolean true
 
diff --git a/images/capi/packer/raw/linux/ubuntu/http/base/preseed.cfg b/images/capi/packer/raw/linux/ubuntu/http/base/preseed.cfg.tmpl
similarity index 97%
rename from images/capi/packer/raw/linux/ubuntu/http/base/preseed.cfg
rename to images/capi/packer/raw/linux/ubuntu/http/base/preseed.cfg.tmpl
index e6ff3314c..30cc11641 100644
--- a/images/capi/packer/raw/linux/ubuntu/http/base/preseed.cfg
+++ b/images/capi/packer/raw/linux/ubuntu/http/base/preseed.cfg.tmpl
@@ -79,8 +79,8 @@ d-i partman-efi/non_efi_system boolean false
 # Create the default user.
 d-i passwd/user-fullname string builder
 d-i passwd/username string builder
-d-i passwd/user-password password builder
-d-i passwd/user-password-again password builder
+d-i passwd/user-password password $SSH_PASSWORD
+d-i passwd/user-password-again password $SSH_PASSWORD
 d-i user-setup/encrypt-home boolean false
 d-i user-setup/allow-password-weak boolean true
 
diff --git a/images/capi/packer/raw/packer.json b/images/capi/packer/raw/packer.json.tmpl
similarity index 99%
rename from images/capi/packer/raw/packer.json
rename to images/capi/packer/raw/packer.json.tmpl
index 385d78310..4535322f6 100644
--- a/images/capi/packer/raw/packer.json
+++ b/images/capi/packer/raw/packer.json.tmpl
@@ -188,7 +188,7 @@
     "output_directory": "./output/{{user `build_name`}}-kube-{{user `kubernetes_semver`}}",
     "python_path": "",
     "qemu_binary": "qemu-system-x86_64",
-    "ssh_password": "{{ uuid }}",
+    "ssh_password": "$SSH_PASSWORD",
     "ssh_username": "builder",
     "vm_name": "{{user `build_name`}}-kube-{{user `kubernetes_semver`}}"
   }
-- 
2.46.1

