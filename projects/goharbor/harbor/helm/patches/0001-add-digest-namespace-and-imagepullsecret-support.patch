From b7528fa9458e165144880046f94460435b5fbe59 Mon Sep 17 00:00:00 2001
From: Jhaanvi Golani <jhaanvi@amazon.com>
Date: Mon, 24 Feb 2025 09:14:39 -0800
Subject: [PATCH] add digest namespace and imagepullsecret support

---
 templates/_helpers.tpl                       | 12 ++++
 templates/core/core-cm.yaml                  |  2 +-
 templates/core/core-dpl.yaml                 |  5 +-
 templates/core/core-pre-upgrade-job.yaml     |  5 +-
 templates/core/core-secret.yaml              |  4 +-
 templates/core/core-svc.yaml                 |  2 +-
 templates/core/core-tls.yaml                 |  2 +-
 templates/core/secret.yaml                   | 16 +++++
 templates/database/database-secret.yaml      |  2 +-
 templates/database/database-ss.yaml          |  8 ++-
 templates/database/database-svc.yaml         |  2 +-
 templates/exporter/exporter-cm-env.yaml      |  2 +-
 templates/exporter/exporter-dpl.yaml         |  5 +-
 templates/exporter/exporter-secret.yaml      |  2 +-
 templates/exporter/exporter-svc.yaml         |  2 +-
 templates/ingress/ingress.yaml               |  2 +-
 templates/ingress/secret.yaml                |  2 +-
 templates/internal/auto-tls.yaml             | 10 +--
 templates/jobservice/jobservice-cm-env.yaml  |  2 +-
 templates/jobservice/jobservice-cm.yaml      |  2 +-
 templates/jobservice/jobservice-dpl.yaml     |  5 +-
 templates/jobservice/jobservice-pvc.yaml     |  2 +-
 templates/jobservice/jobservice-secrets.yaml |  2 +-
 templates/jobservice/jobservice-svc.yaml     |  2 +-
 templates/jobservice/jobservice-tls.yaml     |  2 +-
 templates/metrics/metrics-svcmon.yaml        |  2 +-
 templates/nginx/configmap-http.yaml          |  2 +-
 templates/nginx/configmap-https.yaml         |  2 +-
 templates/nginx/deployment.yaml              |  5 +-
 templates/nginx/secret.yaml                  |  2 +-
 templates/nginx/service.yaml                 |  1 +
 templates/portal/configmap.yaml              |  2 +-
 templates/portal/deployment.yaml             |  5 +-
 templates/portal/service.yaml                |  2 +-
 templates/portal/tls.yaml                    |  2 +-
 templates/redis/service.yaml                 |  2 +-
 templates/redis/statefulset.yaml             |  6 +-
 templates/registry/registry-cm.yaml          |  2 +-
 templates/registry/registry-dpl.yaml         |  7 +-
 templates/registry/registry-pvc.yaml         |  2 +-
 templates/registry/registry-secret.yaml      |  4 +-
 templates/registry/registry-svc.yaml         |  2 +-
 templates/registry/registry-tls.yaml         |  2 +-
 templates/registry/registryctl-cm.yaml       |  2 +-
 templates/registry/registryctl-secret.yaml   |  2 +-
 templates/trivy/trivy-secret.yaml            |  2 +-
 templates/trivy/trivy-sts.yaml               |  6 +-
 templates/trivy/trivy-svc.yaml               |  2 +-
 templates/trivy/trivy-tls.yaml               |  2 +-
 values.yaml                                  | 70 +++++++++++---------
 50 files changed, 146 insertions(+), 94 deletions(-)
 create mode 100644 templates/core/secret.yaml

diff --git a/templates/_helpers.tpl b/templates/_helpers.tpl
index 95643c4..72419ce 100644
--- a/templates/_helpers.tpl
+++ b/templates/_helpers.tpl
@@ -604,3 +604,15 @@ app: "{{ template "harbor.name" . }}"
 {{- define "harbor.ingress.kubeVersion" -}}
   {{- default .Capabilities.KubeVersion.Version .Values.expose.ingress.kubeVersionOverride -}}
 {{- end -}}
+
+{{/* Generate image repository path. */}}
+{{- define "harbor.image.repository.path" -}}
+  {{- .repository }}@{{ .digest -}}
+{{- end -}}
+
+{{/* Create imagePullSecret */}}
+{{- define "imagePullSecret" }}
+{{- with .Values.imageCredentials }}
+{{- printf "{\"auths\":{\"%s\":{\"username\":\"%s\",\"password\":\"%s\",\"email\":\"%s\",\"auth\":\"%s\"}}}" .registry .username .password .email (printf "%s:%s" .username .password | b64enc) | b64enc }}
+{{- end }}
+{{- end }}
diff --git a/templates/core/core-cm.yaml b/templates/core/core-cm.yaml
index 17a8207..b038084 100644
--- a/templates/core/core-cm.yaml
+++ b/templates/core/core-cm.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: {{ template "harbor.core" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/core/core-dpl.yaml b/templates/core/core-dpl.yaml
index 4705c5f..ad138c3 100644
--- a/templates/core/core-dpl.yaml
+++ b/templates/core/core-dpl.yaml
@@ -2,7 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.core" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: core
@@ -16,6 +16,7 @@ spec:
       component: core
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: core
@@ -64,7 +65,7 @@ spec:
       {{- end }}
       containers:
       - name: core
-        image: {{ .Values.core.image.repository }}:{{ .Values.core.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.core.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         {{- if .Values.core.startupProbe.enabled }}
         startupProbe:
diff --git a/templates/core/core-pre-upgrade-job.yaml b/templates/core/core-pre-upgrade-job.yaml
index 8727156..e428868 100644
--- a/templates/core/core-pre-upgrade-job.yaml
+++ b/templates/core/core-pre-upgrade-job.yaml
@@ -3,7 +3,7 @@ apiVersion: batch/v1
 kind: Job
 metadata:
   name: migration-job
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: migrator
@@ -15,6 +15,7 @@ metadata:
 spec:
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.matchLabels" . | indent 8 }}
         component: migrator
@@ -33,7 +34,7 @@ spec:
       terminationGracePeriodSeconds: 120
       containers:
       - name: core-job
-        image: {{ .Values.core.image.repository }}:{{ .Values.core.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.core.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         command: ["/harbor/harbor_core", "-mode=migrate"]
         envFrom:
diff --git a/templates/core/core-secret.yaml b/templates/core/core-secret.yaml
index ea9d4cf..008f449 100644
--- a/templates/core/core-secret.yaml
+++ b/templates/core/core-secret.yaml
@@ -3,13 +3,13 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.core" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
 data:
   {{- if not .Values.existingSecretSecretKey }}
-  secretKey: {{ .Values.secretKey | b64enc | quote }}
+  secretKey: {{ required ".Values.secretKey must be set!" .Values.secretKey | b64enc | quote }}
   {{- end }}
   {{- if not .Values.core.existingSecret }}
   secret: {{ .Values.core.secret | default (include "harbor.secretKeyHelper" (dict "key" "secret" "data" $existingSecret.data)) | default (randAlphaNum 16) | b64enc | quote }}
diff --git a/templates/core/core-svc.yaml b/templates/core/core-svc.yaml
index a1d2368..b8d1a7a 100644
--- a/templates/core/core-svc.yaml
+++ b/templates/core/core-svc.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: {{ template "harbor.core" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 {{- with .Values.core.serviceAnnotations }}
diff --git a/templates/core/core-tls.yaml b/templates/core/core-tls.yaml
index d90d30c..5195b6f 100644
--- a/templates/core/core-tls.yaml
+++ b/templates/core/core-tls.yaml
@@ -4,7 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.core.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/core/secret.yaml b/templates/core/secret.yaml
new file mode 100644
index 0000000..f87c66c
--- /dev/null
+++ b/templates/core/secret.yaml
@@ -0,0 +1,16 @@
+{{- if .Values.imagePullSecrets }}
+{{- if .Values.pullSecretName }}
+apiVersion: v1
+kind: Secret
+metadata:
+  name: {{ .Values.pullSecretName }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
+type: kubernetes.io/dockerconfigjson
+data:
+  {{- if .Values.pullSecretData }}
+  .dockerconfigjson: {{ .Values.pullSecretData }}
+  {{- else }}
+  .dockerconfigjson: {{ template "imagePullSecret" . }}
+  {{- end }}
+{{- end }}
+{{- end }}
diff --git a/templates/database/database-secret.yaml b/templates/database/database-secret.yaml
index 0d07ec2..07c0d7b 100644
--- a/templates/database/database-secret.yaml
+++ b/templates/database/database-secret.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.database" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/database/database-ss.yaml b/templates/database/database-ss.yaml
index 8bddd29..3cda88f 100644
--- a/templates/database/database-ss.yaml
+++ b/templates/database/database-ss.yaml
@@ -4,7 +4,7 @@ apiVersion: apps/v1
 kind: StatefulSet
 metadata:
   name: "{{ template "harbor.database" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: database
@@ -18,6 +18,7 @@ spec:
       component: database
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: database
@@ -49,7 +50,7 @@ spec:
       # use this init container to correct the permission
       # as "fsGroup" applied before the init container running, the container has enough permission to execute the command
       - name: "data-permissions-ensurer"
-        image: {{ .Values.database.internal.image.repository }}:{{ .Values.database.internal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.database.internal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         {{- if not (empty .Values.containerSecurityContext) }}
         securityContext: {{ .Values.containerSecurityContext | toYaml | nindent 10 }}
@@ -69,7 +70,7 @@ spec:
       {{- end }}
       containers:
       - name: database
-        image: {{ .Values.database.internal.image.repository }}:{{ .Values.database.internal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.database.internal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         {{- if not (empty .Values.containerSecurityContext) }}
         securityContext: {{ .Values.containerSecurityContext | toYaml | nindent 10 }}
@@ -143,6 +144,7 @@ spec:
     kind: PersistentVolumeClaim
     metadata:
       name: "database-data"
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.legacy.labels" . | indent 8 }}
       annotations:
diff --git a/templates/database/database-svc.yaml b/templates/database/database-svc.yaml
index aef4c6d..860e001 100644
--- a/templates/database/database-svc.yaml
+++ b/templates/database/database-svc.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.database" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/exporter/exporter-cm-env.yaml b/templates/exporter/exporter-cm-env.yaml
index 3f91103..e9e81aa 100644
--- a/templates/exporter/exporter-cm-env.yaml
+++ b/templates/exporter/exporter-cm-env.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.exporter" . }}-env"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/exporter/exporter-dpl.yaml b/templates/exporter/exporter-dpl.yaml
index 30894a6..b494f67 100644
--- a/templates/exporter/exporter-dpl.yaml
+++ b/templates/exporter/exporter-dpl.yaml
@@ -3,7 +3,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.exporter" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: exporter
@@ -17,6 +17,7 @@ spec:
       component: exporter
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: exporter
@@ -59,7 +60,7 @@ spec:
 {{- end }}
       containers:
       - name: exporter
-        image: {{ .Values.exporter.image.repository }}:{{ .Values.exporter.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.exporter.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/exporter/exporter-secret.yaml b/templates/exporter/exporter-secret.yaml
index 02c74d0..795b70a 100644
--- a/templates/exporter/exporter-secret.yaml
+++ b/templates/exporter/exporter-secret.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.exporter" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/exporter/exporter-svc.yaml b/templates/exporter/exporter-svc.yaml
index 11306e2..8d1a62c 100644
--- a/templates/exporter/exporter-svc.yaml
+++ b/templates/exporter/exporter-svc.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.exporter" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/ingress/ingress.yaml b/templates/ingress/ingress.yaml
index 06096b8..e3f35af 100644
--- a/templates/ingress/ingress.yaml
+++ b/templates/ingress/ingress.yaml
@@ -35,7 +35,7 @@ apiVersion: networking.k8s.io/v1
 kind: Ingress
 metadata:
   name: "{{ template "harbor.ingress" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 {{- if $ingress.labels }}
diff --git a/templates/ingress/secret.yaml b/templates/ingress/secret.yaml
index 48343b0..73b7f21 100644
--- a/templates/ingress/secret.yaml
+++ b/templates/ingress/secret.yaml
@@ -6,7 +6,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.ingress" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/internal/auto-tls.yaml b/templates/internal/auto-tls.yaml
index 32807cf..0d41ab8 100644
--- a/templates/internal/auto-tls.yaml
+++ b/templates/internal/auto-tls.yaml
@@ -14,7 +14,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.core.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -28,7 +28,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.jobservice.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -42,7 +42,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.registry.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -56,7 +56,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.portal.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -73,7 +73,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.trivy.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/jobservice/jobservice-cm-env.yaml b/templates/jobservice/jobservice-cm-env.yaml
index f135913..6193acf 100644
--- a/templates/jobservice/jobservice-cm-env.yaml
+++ b/templates/jobservice/jobservice-cm-env.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.jobservice" . }}-env"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/jobservice/jobservice-cm.yaml b/templates/jobservice/jobservice-cm.yaml
index c950e67..0b7b43f 100644
--- a/templates/jobservice/jobservice-cm.yaml
+++ b/templates/jobservice/jobservice-cm.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/jobservice/jobservice-dpl.yaml b/templates/jobservice/jobservice-dpl.yaml
index 3e42669..f88c533 100644
--- a/templates/jobservice/jobservice-dpl.yaml
+++ b/templates/jobservice/jobservice-dpl.yaml
@@ -2,7 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: jobservice
@@ -21,6 +21,7 @@ spec:
       component: jobservice
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: jobservice
@@ -70,7 +71,7 @@ spec:
       {{- end }}
       containers:
       - name: jobservice
-        image: {{ .Values.jobservice.image.repository }}:{{ .Values.jobservice.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.jobservice.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/jobservice/jobservice-pvc.yaml b/templates/jobservice/jobservice-pvc.yaml
index eb781ee..787d126 100644
--- a/templates/jobservice/jobservice-pvc.yaml
+++ b/templates/jobservice/jobservice-pvc.yaml
@@ -4,7 +4,7 @@ kind: PersistentVolumeClaim
 apiVersion: v1
 metadata:
   name: {{ template "harbor.jobservice" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   annotations:
   {{- range $key, $value := $jobLog.annotations }}
     {{ $key }}: {{ $value | quote }}
diff --git a/templates/jobservice/jobservice-secrets.yaml b/templates/jobservice/jobservice-secrets.yaml
index 7706c35..66d9ab1 100644
--- a/templates/jobservice/jobservice-secrets.yaml
+++ b/templates/jobservice/jobservice-secrets.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/jobservice/jobservice-svc.yaml b/templates/jobservice/jobservice-svc.yaml
index 9bddc43..21b18b8 100644
--- a/templates/jobservice/jobservice-svc.yaml
+++ b/templates/jobservice/jobservice-svc.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/jobservice/jobservice-tls.yaml b/templates/jobservice/jobservice-tls.yaml
index 58809ec..3436da6 100644
--- a/templates/jobservice/jobservice-tls.yaml
+++ b/templates/jobservice/jobservice-tls.yaml
@@ -4,7 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.jobservice.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/metrics/metrics-svcmon.yaml b/templates/metrics/metrics-svcmon.yaml
index d566285..b355734 100644
--- a/templates/metrics/metrics-svcmon.yaml
+++ b/templates/metrics/metrics-svcmon.yaml
@@ -3,7 +3,7 @@ apiVersion: monitoring.coreos.com/v1
 kind: ServiceMonitor
 metadata:
   name: {{ template "harbor.fullname" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels: {{ include "harbor.labels" . | nindent 4 }}
 {{- if .Values.metrics.serviceMonitor.additionalLabels }}
 {{ toYaml .Values.metrics.serviceMonitor.additionalLabels | indent 4 }}
diff --git a/templates/nginx/configmap-http.yaml b/templates/nginx/configmap-http.yaml
index 78efa18..8976074 100644
--- a/templates/nginx/configmap-http.yaml
+++ b/templates/nginx/configmap-http.yaml
@@ -4,7 +4,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: {{ template "harbor.nginx" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/nginx/configmap-https.yaml b/templates/nginx/configmap-https.yaml
index 3a80e29..da5d891 100644
--- a/templates/nginx/configmap-https.yaml
+++ b/templates/nginx/configmap-https.yaml
@@ -4,7 +4,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: {{ template "harbor.nginx" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/nginx/deployment.yaml b/templates/nginx/deployment.yaml
index 0c8bc40..8af5d84 100644
--- a/templates/nginx/deployment.yaml
+++ b/templates/nginx/deployment.yaml
@@ -3,7 +3,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.nginx" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: nginx
@@ -17,6 +17,7 @@ spec:
       component: nginx
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: nginx
@@ -60,7 +61,7 @@ spec:
 {{- end }}
       containers:
       - name: nginx
-        image: "{{ .Values.nginx.image.repository }}:{{ .Values.nginx.image.tag }}"
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.nginx.image }}
         imagePullPolicy: "{{ .Values.imagePullPolicy }}"
         {{- $_ := set . "scheme" "HTTP" -}}
         {{- $_ := set . "port" "8080" -}}
diff --git a/templates/nginx/secret.yaml b/templates/nginx/secret.yaml
index b855e7e..24e4ed7 100644
--- a/templates/nginx/secret.yaml
+++ b/templates/nginx/secret.yaml
@@ -6,7 +6,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.nginx" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/nginx/service.yaml b/templates/nginx/service.yaml
index 9554cd4..ee6f364 100644
--- a/templates/nginx/service.yaml
+++ b/templates/nginx/service.yaml
@@ -2,6 +2,7 @@
 apiVersion: v1
 kind: Service
 metadata:
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
 {{- if eq .Values.expose.type "clusterIP" }}
 {{- $clusterIP := .Values.expose.clusterIP }}
   name: {{ $clusterIP.name }}
diff --git a/templates/portal/configmap.yaml b/templates/portal/configmap.yaml
index af56783..bdeb2b1 100644
--- a/templates/portal/configmap.yaml
+++ b/templates/portal/configmap.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.portal" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/portal/deployment.yaml b/templates/portal/deployment.yaml
index 88bcd49..b11525b 100644
--- a/templates/portal/deployment.yaml
+++ b/templates/portal/deployment.yaml
@@ -2,7 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: "{{ template "harbor.portal" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: portal
@@ -16,6 +16,7 @@ spec:
       component: portal
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: portal
@@ -61,7 +62,7 @@ spec:
       {{- end }}
       containers:
       - name: portal
-        image: {{ .Values.portal.image.repository }}:{{ .Values.portal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.portal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
 {{- if .Values.portal.resources }}
         resources:
diff --git a/templates/portal/service.yaml b/templates/portal/service.yaml
index 2ce2482..6d70cb2 100644
--- a/templates/portal/service.yaml
+++ b/templates/portal/service.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.portal" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 {{- with .Values.portal.serviceAnnotations }}
diff --git a/templates/portal/tls.yaml b/templates/portal/tls.yaml
index e61a7d3..75b0be1 100644
--- a/templates/portal/tls.yaml
+++ b/templates/portal/tls.yaml
@@ -4,7 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.portal.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/redis/service.yaml b/templates/redis/service.yaml
index 8bb8e85..d6ab25f 100644
--- a/templates/redis/service.yaml
+++ b/templates/redis/service.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: {{ template "harbor.redis" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/redis/statefulset.yaml b/templates/redis/statefulset.yaml
index 2316f69..41c0e12 100644
--- a/templates/redis/statefulset.yaml
+++ b/templates/redis/statefulset.yaml
@@ -4,7 +4,7 @@ apiVersion: apps/v1
 kind: StatefulSet
 metadata:
   name: {{ template "harbor.redis" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: redis
@@ -18,6 +18,7 @@ spec:
       component: redis
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: redis
@@ -48,7 +49,7 @@ spec:
       {{- end }}
       containers:
       - name: redis
-        image: {{ .Values.redis.internal.image.repository }}:{{ .Values.redis.internal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.redis.internal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         {{- if not (empty .Values.containerSecurityContext) }}
         securityContext: {{ .Values.containerSecurityContext | toYaml | nindent 10 }}
@@ -106,6 +107,7 @@ spec:
     kind: PersistentVolumeClaim
     metadata:
       name: data
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.legacy.labels" . | indent 8 }}
       annotations:
diff --git a/templates/registry/registry-cm.yaml b/templates/registry/registry-cm.yaml
index 2ef398e..66a525e 100644
--- a/templates/registry/registry-cm.yaml
+++ b/templates/registry/registry-cm.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.registry" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/registry/registry-dpl.yaml b/templates/registry/registry-dpl.yaml
index a86e2ee..6a772a6 100644
--- a/templates/registry/registry-dpl.yaml
+++ b/templates/registry/registry-dpl.yaml
@@ -4,7 +4,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: "{{ template "harbor.registry" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: registry
@@ -23,6 +23,7 @@ spec:
       component: registry
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: registry
@@ -73,7 +74,7 @@ spec:
       {{- end }}
       containers:
       - name: registry
-        image: {{ .Values.registry.registry.image.repository }}:{{ .Values.registry.registry.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.registry.registry.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
@@ -211,7 +212,7 @@ spec:
 {{ include "harbor.caBundleVolumeMount" . | indent 8 }}
         {{- end }}
       - name: registryctl
-        image: {{ .Values.registry.controller.image.repository }}:{{ .Values.registry.controller.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.registry.controller.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/registry/registry-pvc.yaml b/templates/registry/registry-pvc.yaml
index 712c211..bf4f146 100644
--- a/templates/registry/registry-pvc.yaml
+++ b/templates/registry/registry-pvc.yaml
@@ -5,7 +5,7 @@ kind: PersistentVolumeClaim
 apiVersion: v1
 metadata:
   name: {{ template "harbor.registry" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   annotations:
   {{- range $key, $value := $registry.annotations }}
     {{ $key }}: {{ $value | quote }}
diff --git a/templates/registry/registry-secret.yaml b/templates/registry/registry-secret.yaml
index 11ada3b..053c774 100644
--- a/templates/registry/registry-secret.yaml
+++ b/templates/registry/registry-secret.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.registry" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
@@ -44,7 +44,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.registry" . }}-htpasswd"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/registry/registry-svc.yaml b/templates/registry/registry-svc.yaml
index 7e30c47..c54b927 100644
--- a/templates/registry/registry-svc.yaml
+++ b/templates/registry/registry-svc.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.registry" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/registry/registry-tls.yaml b/templates/registry/registry-tls.yaml
index ec4540c..5461b94 100644
--- a/templates/registry/registry-tls.yaml
+++ b/templates/registry/registry-tls.yaml
@@ -4,7 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.registry.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/registry/registryctl-cm.yaml b/templates/registry/registryctl-cm.yaml
index 61b2c5e..d8f5669 100644
--- a/templates/registry/registryctl-cm.yaml
+++ b/templates/registry/registryctl-cm.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.registryCtl" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/registry/registryctl-secret.yaml b/templates/registry/registryctl-secret.yaml
index 324a2e0..936ba34 100644
--- a/templates/registry/registryctl-secret.yaml
+++ b/templates/registry/registryctl-secret.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.registryCtl" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/trivy/trivy-secret.yaml b/templates/trivy/trivy-secret.yaml
index b13f880..91fe39a 100644
--- a/templates/trivy/trivy-secret.yaml
+++ b/templates/trivy/trivy-secret.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.trivy" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/trivy/trivy-sts.yaml b/templates/trivy/trivy-sts.yaml
index 19b01a2..284e6a2 100644
--- a/templates/trivy/trivy-sts.yaml
+++ b/templates/trivy/trivy-sts.yaml
@@ -4,7 +4,7 @@ apiVersion: apps/v1
 kind: StatefulSet
 metadata:
   name: {{ template "harbor.trivy" . }}
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: trivy
@@ -18,6 +18,7 @@ spec:
       component: trivy
   template:
     metadata:
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: trivy
@@ -63,7 +64,7 @@ spec:
       {{- end }}
       containers:
         - name: trivy
-          image: {{ .Values.trivy.image.repository }}:{{ .Values.trivy.image.tag }}
+          image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.trivy.image }}
           imagePullPolicy: {{ .Values.imagePullPolicy }}
           {{- if not (empty .Values.containerSecurityContext) }}
           securityContext: {{ .Values.containerSecurityContext | toYaml | nindent 12 }}
@@ -215,6 +216,7 @@ spec:
     kind: PersistentVolumeClaim
     metadata:
       name: data
+      namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
       labels:
 {{ include "harbor.legacy.labels" . | indent 8 }}
       annotations:
diff --git a/templates/trivy/trivy-svc.yaml b/templates/trivy/trivy-svc.yaml
index a9fb9bf..129f210 100644
--- a/templates/trivy/trivy-svc.yaml
+++ b/templates/trivy/trivy-svc.yaml
@@ -3,7 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.trivy" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/trivy/trivy-tls.yaml b/templates/trivy/trivy-tls.yaml
index 58bce4e..d19e7ce 100644
--- a/templates/trivy/trivy-tls.yaml
+++ b/templates/trivy/trivy-tls.yaml
@@ -4,7 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.trivy.secretName" . }}"
-  namespace: {{ .Release.Namespace | quote }}
+  namespace: {{ .Release.Namespace | default .Values.defaultNamespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/values.yaml b/values.yaml
index e00fafc..487fa3f 100644
--- a/values.yaml
+++ b/values.yaml
@@ -1,7 +1,19 @@
+sourceRegistry: "public.ecr.aws/eks-anywhere"
+defaultNamespace: "harbor"
+
+# Values for configuring pull secrets through charts
+pullSecretName: ""
+pullSecretData: ""
+imageCredentials:
+  registry: ""
+  username: ""
+  password: ""
+  email: ""
+
 expose:
   # Set how to expose the service. Set the type as "ingress", "clusterIP", "nodePort" or "loadBalancer"
   # and fill the information in the corresponding section
-  type: ingress
+  type: nodePort
   tls:
     # Enable TLS or not.
     # Delete the "ssl-redirect" annotations in "expose.ingress.annotations" when TLS is disabled and "expose.type" is "ingress"
@@ -16,7 +28,7 @@ expose:
     # The tls certificate can be generated manually or by cert manager
     # 3) none: configure no tls certificate for the ingress. If the default
     # tls certificate is configured in the ingress controller, choose this option
-    certSource: auto
+    certSource: secret
     auto:
       # The common name used to generate the certificate, it's necessary
       # when the type isn't "ingress"
@@ -25,7 +37,7 @@ expose:
       # The name of secret which contains keys named:
       # "tls.crt" - the certificate
       # "tls.key" - the private key
-      secretName: ""
+      secretName: "harbor-tls-secret"
   ingress:
     hosts:
       core: core.harbor.domain
@@ -120,7 +132,7 @@ expose:
 # the IP address of k8s node
 #
 # If Harbor is deployed behind the proxy, set it as the URL of proxy
-externalURL: https://core.harbor.domain
+externalURL: https://127.0.0.1:30003
 
 # The persistence is enabled by default and a default StorageClass
 # is needed in the k8s cluster to provision volumes dynamically.
@@ -289,7 +301,7 @@ harborAdminPassword: "Harbor12345"
 # in each component tls cert files need to provided in advance.
 internalTLS:
   # If internal TLS enabled
-  enabled: false
+  enabled: true
   # enable strong ssl ciphers (default: false)
   strong_ssl_ciphers: false
   # There are three ways to provide tls
@@ -363,7 +375,7 @@ imagePullSecrets:
 # The update strategy for deployments with persistent volumes(jobservice, registry): "RollingUpdate" or "Recreate"
 # Set it as "Recreate" when "RWM" for volumes isn't supported
 updateStrategy:
-  type: RollingUpdate
+  type: Recreate
 
 # debug, info, warning, error or fatal
 logLevel: info
@@ -374,7 +386,7 @@ logLevel: info
 caSecretName: ""
 
 # The secret key used for encryption. Must be a string of 16 chars.
-secretKey: "not-a-secure-key"
+secretKey: ""
 # If using existingSecretSecretKey, the key must be secretKey
 existingSecretSecretKey: ""
 
@@ -498,8 +510,8 @@ containerSecurityContext:
 # If service exposed via "ingress", the Nginx will not be used
 nginx:
   image:
-    repository: goharbor/nginx-photon
-    tag: v2.14.2
+    repository: harbor/harbor-nginx
+    digest: {{harbor/harbor-nginx}}    
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -529,9 +541,8 @@ nginx:
 
 portal:
   image:
-    repository: goharbor/harbor-portal
-    tag: v2.14.2
-  # set the service account to be used, default if left empty
+    repository: harbor/harbor-portal
+    digest: {{harbor/harbor-portal}}  # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
   automountServiceAccountToken: false
@@ -569,8 +580,8 @@ portal:
 
 core:
   image:
-    repository: goharbor/harbor-core
-    tag: v2.14.2
+    repository: harbor/harbor-core
+    digest: {{harbor/harbor-core}}
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -658,8 +669,8 @@ core:
 
 jobservice:
   image:
-    repository: goharbor/harbor-jobservice
-    tag: v2.14.2
+    repository: harbor/harbor-jobservice
+    digest: {{harbor/harbor-jobservice}}
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -721,8 +732,8 @@ jobservice:
 registry:
   registry:
     image:
-      repository: goharbor/registry-photon
-      tag: v2.14.2
+      repository: harbor/harbor-registry
+      digest: {{harbor/harbor-registry}}
     # resources:
     #  requests:
     #    memory: 256Mi
@@ -730,8 +741,8 @@ registry:
     extraEnvVars: []
   controller:
     image:
-      repository: goharbor/harbor-registryctl
-      tag: v2.14.2
+      repository: harbor/harbor-registryctl
+      tag: {{harbor/harbor-registryctl}}
     # resources:
     #  requests:
     #    memory: 256Mi
@@ -776,7 +787,7 @@ registry:
   # Key within the existing secret for the registry service secret
   existingSecretKey: REGISTRY_HTTP_SECRET
   # If true, the registry returns relative URLs in Location headers. The client is responsible for resolving the correct URL.
-  relativeurls: false
+  relativeurls: true
   credentials:
     username: "harbor_registry_user"
     password: "harbor_registry_password"
@@ -810,9 +821,8 @@ trivy:
   enabled: true
   image:
     # repository the repository for Trivy adapter image
-    repository: goharbor/trivy-adapter-photon
-    # tag the tag for Trivy adapter image
-    tag: v2.14.2
+    repository: harbor/harbor-trivy
+    digest: {{harbor/harbor-trivy}}
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -915,8 +925,8 @@ database:
   type: internal
   internal:
     image:
-      repository: goharbor/harbor-db
-      tag: v2.14.2
+      repository: harbor/harbor-db
+      digest: {{harbor/harbor-db}}
     # set the service account to be used, default if left empty
     serviceAccountName: ""
     # mount the service account token
@@ -995,8 +1005,8 @@ redis:
   type: internal
   internal:
     image:
-      repository: goharbor/redis-photon
-      tag: v2.14.2
+      repository: harbor/harbor-redis
+      digest: {{harbor/harbor-redis}}
     # set the service account to be used, default if left empty
     serviceAccountName: ""
     # mount the service account token
@@ -1065,8 +1075,8 @@ redis:
 
 exporter:
   image:
-    repository: goharbor/harbor-exporter
-    tag: v2.14.2
+    repository: harbor/harbor-exporter
+    digest: {{harbor/harbor-exporter}}
   serviceAccountName: ""
   # mount the service account token
   automountServiceAccountToken: false
-- 
2.34.1

