From bae6614ac9212043592e69151dad8155b05cf5cb Mon Sep 17 00:00:00 2001
From: Vincent Ni <kangqini@amazon.com>
Date: Tue, 14 Jun 2022 15:15:41 -0700
Subject: [PATCH] add digest and namespace support

---
 templates/_helpers.tpl                        |  5 ++
 templates/chartmuseum/chartmuseum-cm.yaml     |  1 +
 templates/chartmuseum/chartmuseum-dpl.yaml    |  4 +-
 templates/chartmuseum/chartmuseum-pvc.yaml    |  1 +
 templates/chartmuseum/chartmuseum-secret.yaml |  1 +
 templates/chartmuseum/chartmuseum-svc.yaml    |  1 +
 templates/chartmuseum/chartmuseum-tls.yaml    |  1 +
 templates/core/core-cm.yaml                   |  1 +
 templates/core/core-dpl.yaml                  |  4 +-
 templates/core/core-pre-upgrade-job.yaml      |  4 +-
 templates/core/core-secret.yaml               |  3 +-
 templates/core/core-svc.yaml                  |  1 +
 templates/core/core-tls.yaml                  |  1 +
 templates/database/database-secret.yaml       |  1 +
 templates/database/database-ss.yaml           |  9 ++-
 templates/database/database-svc.yaml          |  1 +
 templates/exporter/exporter-cm-env.yaml       |  1 +
 templates/exporter/exporter-dpl.yaml          |  4 +-
 templates/exporter/exporter-secret.yaml       |  1 +
 templates/exporter/exporter-svc.yaml          |  1 +
 templates/ingress/ingress.yaml                |  2 +
 templates/ingress/secret.yaml                 |  1 +
 templates/internal/auto-tls.yaml              |  6 ++
 templates/jobservice/jobservice-cm-env.yaml   |  1 +
 templates/jobservice/jobservice-cm.yaml       |  1 +
 templates/jobservice/jobservice-dpl.yaml      |  4 +-
 templates/jobservice/jobservice-pvc.yaml      |  1 +
 templates/jobservice/jobservice-secrets.yaml  |  1 +
 templates/jobservice/jobservice-svc.yaml      |  1 +
 templates/jobservice/jobservice-tls.yaml      |  1 +
 templates/metrics/metrics-svcmon.yaml         |  1 +
 templates/nginx/configmap-http.yaml           |  1 +
 templates/nginx/configmap-https.yaml          |  1 +
 templates/nginx/deployment.yaml               |  4 +-
 templates/nginx/secret.yaml                   |  1 +
 templates/nginx/service.yaml                  |  1 +
 templates/notary/notary-secret.yaml           |  1 +
 templates/notary/notary-server.yaml           |  4 +-
 templates/notary/notary-signer.yaml           |  4 +-
 templates/notary/notary-svc.yaml              |  2 +
 templates/portal/configmap.yaml               |  1 +
 templates/portal/deployment.yaml              |  4 +-
 templates/portal/service.yaml                 |  1 +
 templates/portal/tls.yaml                     |  1 +
 templates/redis/service.yaml                  |  1 +
 templates/redis/statefulset.yaml              |  5 +-
 templates/registry/registry-cm.yaml           |  1 +
 templates/registry/registry-dpl.yaml          |  6 +-
 templates/registry/registry-pvc.yaml          |  1 +
 templates/registry/registry-secret.yaml       |  2 +
 templates/registry/registry-svc.yaml          |  1 +
 templates/registry/registry-tls.yaml          |  1 +
 templates/registry/registryctl-cm.yaml        |  1 +
 templates/registry/registryctl-secret.yaml    |  1 +
 templates/trivy/trivy-secret.yaml             |  1 +
 templates/trivy/trivy-sts.yaml                |  5 +-
 templates/trivy/trivy-svc.yaml                |  1 +
 templates/trivy/trivy-tls.yaml                |  1 +
 values.yaml                                   | 72 +++++++++----------
 59 files changed, 139 insertions(+), 53 deletions(-)

diff --git a/templates/_helpers.tpl b/templates/_helpers.tpl
index 5eb9910..5706b1f 100644
--- a/templates/_helpers.tpl
+++ b/templates/_helpers.tpl
@@ -603,4 +603,9 @@ postgres://{{ template "harbor.database.username" . }}:{{ template "harbor.datab
 {{/* Allow KubeVersion to be overridden. */}}
 {{- define "harbor.ingress.kubeVersion" -}}
   {{- default .Capabilities.KubeVersion.Version .Values.expose.ingress.kubeVersionOverride -}}
+{{- end -}}
+
+{{/* Generate image repository path. */}}
+{{- define "harbor.image.repository.path" -}}
+  {{- .repository }}@{{ .digest -}}
 {{- end -}}
\ No newline at end of file
diff --git a/templates/chartmuseum/chartmuseum-cm.yaml b/templates/chartmuseum/chartmuseum-cm.yaml
index 8d0a5f8..66279a3 100644
--- a/templates/chartmuseum/chartmuseum-cm.yaml
+++ b/templates/chartmuseum/chartmuseum-cm.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.chartmuseum" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/chartmuseum/chartmuseum-dpl.yaml b/templates/chartmuseum/chartmuseum-dpl.yaml
index d73a73a..ef667c8 100644
--- a/templates/chartmuseum/chartmuseum-dpl.yaml
+++ b/templates/chartmuseum/chartmuseum-dpl.yaml
@@ -3,6 +3,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: "{{ template "harbor.chartmuseum" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: chartmuseum
@@ -20,6 +21,7 @@ spec:
       component: chartmuseum
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: chartmuseum
@@ -49,7 +51,7 @@ spec:
       automountServiceAccountToken: {{ .Values.chartmuseum.automountServiceAccountToken | default false }}
       containers:
       - name: chartmuseum
-        image: {{ .Values.chartmuseum.image.repository }}:{{ .Values.chartmuseum.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.chartmuseum.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/chartmuseum/chartmuseum-pvc.yaml b/templates/chartmuseum/chartmuseum-pvc.yaml
index fd62ac3..a019040 100644
--- a/templates/chartmuseum/chartmuseum-pvc.yaml
+++ b/templates/chartmuseum/chartmuseum-pvc.yaml
@@ -7,6 +7,7 @@ kind: PersistentVolumeClaim
 apiVersion: v1
 metadata:
   name: {{ template "harbor.chartmuseum" . }}
+  namespace: {{ .Release.Namespace | quote }}
   annotations:
   {{- range $key, $value := $chartmuseum.annotations }}
     {{ $key }}: {{ $value | quote }}
diff --git a/templates/chartmuseum/chartmuseum-secret.yaml b/templates/chartmuseum/chartmuseum-secret.yaml
index eefdf79..a8a8f3f 100644
--- a/templates/chartmuseum/chartmuseum-secret.yaml
+++ b/templates/chartmuseum/chartmuseum-secret.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.chartmuseum" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/chartmuseum/chartmuseum-svc.yaml b/templates/chartmuseum/chartmuseum-svc.yaml
index df58475..0406f98 100644
--- a/templates/chartmuseum/chartmuseum-svc.yaml
+++ b/templates/chartmuseum/chartmuseum-svc.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.chartmuseum" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/chartmuseum/chartmuseum-tls.yaml b/templates/chartmuseum/chartmuseum-tls.yaml
index cda17c3..f0e1212 100644
--- a/templates/chartmuseum/chartmuseum-tls.yaml
+++ b/templates/chartmuseum/chartmuseum-tls.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.chartmuseum.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/core/core-cm.yaml b/templates/core/core-cm.yaml
index 41226fb..ac7eedc 100644
--- a/templates/core/core-cm.yaml
+++ b/templates/core/core-cm.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: {{ template "harbor.core" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/core/core-dpl.yaml b/templates/core/core-dpl.yaml
index b94b789..2ef7556 100644
--- a/templates/core/core-dpl.yaml
+++ b/templates/core/core-dpl.yaml
@@ -2,6 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.core" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: core
@@ -14,6 +15,7 @@ spec:
       component: core
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.matchLabels" . | indent 8 }}
         component: core
@@ -44,7 +46,7 @@ spec:
       terminationGracePeriodSeconds: 120
       containers:
       - name: core
-        image: {{ .Values.core.image.repository }}:{{ .Values.core.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.core.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         {{- if .Values.core.startupProbe.enabled }}
         startupProbe:
diff --git a/templates/core/core-pre-upgrade-job.yaml b/templates/core/core-pre-upgrade-job.yaml
index 9681965..6c8e895 100644
--- a/templates/core/core-pre-upgrade-job.yaml
+++ b/templates/core/core-pre-upgrade-job.yaml
@@ -3,6 +3,7 @@ apiVersion: batch/v1
 kind: Job
 metadata:
   name: migration-job
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: migrator
@@ -14,6 +15,7 @@ metadata:
 spec:
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.matchLabels" . | indent 8 }}
         component: migrator
@@ -32,7 +34,7 @@ spec:
       terminationGracePeriodSeconds: 120
       containers:
       - name: core-job
-        image: {{ .Values.core.image.repository }}:{{ .Values.core.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.core.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         command: ["/harbor/harbor_core", "-mode=migrate"]
         envFrom:
diff --git a/templates/core/core-secret.yaml b/templates/core/core-secret.yaml
index 6e3e446..e8fd07c 100644
--- a/templates/core/core-secret.yaml
+++ b/templates/core/core-secret.yaml
@@ -2,11 +2,12 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.core" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
 data:
-  secretKey: {{ .Values.secretKey | b64enc | quote }}
+  secretKey: {{ required ".Values.secretKey must be set!" .Values.secretKey | b64enc | quote }}
   secret: {{ .Values.core.secret | default (randAlphaNum 16) | b64enc | quote }}
 {{- if not .Values.core.secretName }}
   tls.crt: {{ .Files.Get "cert/tls.crt" | b64enc }}
diff --git a/templates/core/core-svc.yaml b/templates/core/core-svc.yaml
index c918e6d..b945830 100644
--- a/templates/core/core-svc.yaml
+++ b/templates/core/core-svc.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: {{ template "harbor.core" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/core/core-tls.yaml b/templates/core/core-tls.yaml
index c52148f..fff0730 100644
--- a/templates/core/core-tls.yaml
+++ b/templates/core/core-tls.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.core.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/database/database-secret.yaml b/templates/database/database-secret.yaml
index 864aff4..0d07ec2 100644
--- a/templates/database/database-secret.yaml
+++ b/templates/database/database-secret.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.database" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/database/database-ss.yaml b/templates/database/database-ss.yaml
index c476c35..5962b87 100644
--- a/templates/database/database-ss.yaml
+++ b/templates/database/database-ss.yaml
@@ -4,6 +4,7 @@ apiVersion: apps/v1
 kind: StatefulSet
 metadata:
   name: "{{ template "harbor.database" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: database
@@ -16,6 +17,7 @@ spec:
       component: database
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: database
@@ -43,7 +45,7 @@ spec:
       # for more detail.
       # we may remove it after several releases
       - name: "data-migrator"
-        image: {{ .Values.database.internal.image.repository }}:{{ .Values.database.internal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.database.internal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         command: ["/bin/sh"]
         args: ["-c", "[ -e /var/lib/postgresql/data/postgresql.conf ] && [ ! -d /var/lib/postgresql/data/pgdata ] && mkdir -m 0700 /var/lib/postgresql/data/pgdata && mv /var/lib/postgresql/data/* /var/lib/postgresql/data/pgdata/ || true"]
@@ -60,7 +62,7 @@ spec:
       # use this init container to correct the permission
       # as "fsGroup" applied before the init container running, the container has enough permission to execute the command
       - name: "data-permissions-ensurer"
-        image: {{ .Values.database.internal.image.repository }}:{{ .Values.database.internal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.database.internal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         command: ["/bin/sh"]
         args: ["-c", "chmod -R 700 /var/lib/postgresql/data/pgdata || true"]
@@ -74,7 +76,7 @@ spec:
             subPath: {{ $database.subPath }}
       containers:
       - name: database
-        image: {{ .Values.database.internal.image.repository }}:{{ .Values.database.internal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.database.internal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           exec:
@@ -138,6 +140,7 @@ spec:
   volumeClaimTemplates:
   - metadata:
       name: "database-data"
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
       annotations:
diff --git a/templates/database/database-svc.yaml b/templates/database/database-svc.yaml
index 6475048..84623d2 100644
--- a/templates/database/database-svc.yaml
+++ b/templates/database/database-svc.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.database" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/exporter/exporter-cm-env.yaml b/templates/exporter/exporter-cm-env.yaml
index 0bf4e7d..4d82ca8 100644
--- a/templates/exporter/exporter-cm-env.yaml
+++ b/templates/exporter/exporter-cm-env.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.exporter" . }}-env"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/exporter/exporter-dpl.yaml b/templates/exporter/exporter-dpl.yaml
index 8f13b8a..53c9c87 100644
--- a/templates/exporter/exporter-dpl.yaml
+++ b/templates/exporter/exporter-dpl.yaml
@@ -3,6 +3,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.exporter" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: exporter
@@ -15,6 +16,7 @@ spec:
       component: exporter
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: exporter
@@ -36,7 +38,7 @@ spec:
       automountServiceAccountToken: {{ .Values.exporter.automountServiceAccountToken | default false }}
       containers:
       - name: exporter
-        image: {{ .Values.exporter.image.repository }}:{{ .Values.exporter.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.exporter.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/exporter/exporter-secret.yaml b/templates/exporter/exporter-secret.yaml
index 1fa6b49..317c87d 100644
--- a/templates/exporter/exporter-secret.yaml
+++ b/templates/exporter/exporter-secret.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.exporter" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/exporter/exporter-svc.yaml b/templates/exporter/exporter-svc.yaml
index 4a6f3fd..6d0d831 100644
--- a/templates/exporter/exporter-svc.yaml
+++ b/templates/exporter/exporter-svc.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.exporter" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/ingress/ingress.yaml b/templates/ingress/ingress.yaml
index 64dbadc..3ca23d1 100644
--- a/templates/ingress/ingress.yaml
+++ b/templates/ingress/ingress.yaml
@@ -38,6 +38,7 @@ apiVersion: networking.k8s.io/v1
 kind: Ingress
 metadata:
   name: "{{ template "harbor.ingress" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 {{- if $ingress.harbor.labels }}
@@ -157,6 +158,7 @@ apiVersion: networking.k8s.io/v1
 kind: Ingress
 metadata:
   name: "{{ template "harbor.ingress-notary" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 {{- if $ingress.notary.labels }}
diff --git a/templates/ingress/secret.yaml b/templates/ingress/secret.yaml
index 0d89af9..678ec69 100644
--- a/templates/ingress/secret.yaml
+++ b/templates/ingress/secret.yaml
@@ -5,6 +5,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.ingress" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/internal/auto-tls.yaml b/templates/internal/auto-tls.yaml
index 6c7a5c9..3b64c56 100644
--- a/templates/internal/auto-tls.yaml
+++ b/templates/internal/auto-tls.yaml
@@ -14,6 +14,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.core.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -27,6 +28,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.jobservice.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -40,6 +42,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.registry.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -53,6 +56,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.portal.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -69,6 +73,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.chartmuseum.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
@@ -86,6 +91,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.trivy.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/jobservice/jobservice-cm-env.yaml b/templates/jobservice/jobservice-cm-env.yaml
index 656a171..40e4e20 100644
--- a/templates/jobservice/jobservice-cm-env.yaml
+++ b/templates/jobservice/jobservice-cm-env.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.jobservice" . }}-env"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/jobservice/jobservice-cm.yaml b/templates/jobservice/jobservice-cm.yaml
index 6500475..85f95dd 100644
--- a/templates/jobservice/jobservice-cm.yaml
+++ b/templates/jobservice/jobservice-cm.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/jobservice/jobservice-dpl.yaml b/templates/jobservice/jobservice-dpl.yaml
index b988027..9ed970b 100644
--- a/templates/jobservice/jobservice-dpl.yaml
+++ b/templates/jobservice/jobservice-dpl.yaml
@@ -2,6 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: jobservice
@@ -19,6 +20,7 @@ spec:
       component: jobservice
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: jobservice
@@ -50,7 +52,7 @@ spec:
       terminationGracePeriodSeconds: 120
       containers:
       - name: jobservice
-        image: {{ .Values.jobservice.image.repository }}:{{ .Values.jobservice.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.jobservice.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/jobservice/jobservice-pvc.yaml b/templates/jobservice/jobservice-pvc.yaml
index 1f6d32d..97543ea 100644
--- a/templates/jobservice/jobservice-pvc.yaml
+++ b/templates/jobservice/jobservice-pvc.yaml
@@ -4,6 +4,7 @@ kind: PersistentVolumeClaim
 apiVersion: v1
 metadata:
   name: {{ template "harbor.jobservice" . }}
+  namespace: {{ .Release.Namespace | quote }}
   annotations:
   {{- range $key, $value := $jobservice.annotations }}
     {{ $key }}: {{ $value | quote }}
diff --git a/templates/jobservice/jobservice-secrets.yaml b/templates/jobservice/jobservice-secrets.yaml
index dfd438c..fcaa311 100644
--- a/templates/jobservice/jobservice-secrets.yaml
+++ b/templates/jobservice/jobservice-secrets.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/jobservice/jobservice-svc.yaml b/templates/jobservice/jobservice-svc.yaml
index d2b7a47..483b40e 100644
--- a/templates/jobservice/jobservice-svc.yaml
+++ b/templates/jobservice/jobservice-svc.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.jobservice" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/jobservice/jobservice-tls.yaml b/templates/jobservice/jobservice-tls.yaml
index 234cb39..511d9c8 100644
--- a/templates/jobservice/jobservice-tls.yaml
+++ b/templates/jobservice/jobservice-tls.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.jobservice.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/metrics/metrics-svcmon.yaml b/templates/metrics/metrics-svcmon.yaml
index ad85229..21fbcbd 100644
--- a/templates/metrics/metrics-svcmon.yaml
+++ b/templates/metrics/metrics-svcmon.yaml
@@ -3,6 +3,7 @@ apiVersion: monitoring.coreos.com/v1
 kind: ServiceMonitor
 metadata:
   name: {{ template "harbor.fullname" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels: {{ include "harbor.labels" . | nindent 4 }}
 {{- if .Values.metrics.serviceMonitor.additionalLabels }}
 {{ toYaml .Values.metrics.serviceMonitor.additionalLabels | indent 4 }}
diff --git a/templates/nginx/configmap-http.yaml b/templates/nginx/configmap-http.yaml
index 3aa4263..a8621d2 100644
--- a/templates/nginx/configmap-http.yaml
+++ b/templates/nginx/configmap-http.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: {{ template "harbor.nginx" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/nginx/configmap-https.yaml b/templates/nginx/configmap-https.yaml
index 91674cb..6ed11f6 100644
--- a/templates/nginx/configmap-https.yaml
+++ b/templates/nginx/configmap-https.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: {{ template "harbor.nginx" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/nginx/deployment.yaml b/templates/nginx/deployment.yaml
index bc1de0a..67f11fc 100644
--- a/templates/nginx/deployment.yaml
+++ b/templates/nginx/deployment.yaml
@@ -3,6 +3,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.nginx" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: nginx
@@ -15,6 +16,7 @@ spec:
       component: nginx
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: nginx
@@ -44,7 +46,7 @@ spec:
       automountServiceAccountToken: {{ .Values.nginx.automountServiceAccountToken | default false }}
       containers:
       - name: nginx
-        image: "{{ .Values.nginx.image.repository }}:{{ .Values.nginx.image.tag }}"
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.nginx.image }}
         imagePullPolicy: "{{ .Values.imagePullPolicy }}"
         {{- $_ := set . "scheme" "HTTP" -}}
         {{- $_ := set . "port" "8080" -}}
diff --git a/templates/nginx/secret.yaml b/templates/nginx/secret.yaml
index c819c55..2dfc1c4 100644
--- a/templates/nginx/secret.yaml
+++ b/templates/nginx/secret.yaml
@@ -5,6 +5,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.nginx" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/nginx/service.yaml b/templates/nginx/service.yaml
index df4da09..892f858 100644
--- a/templates/nginx/service.yaml
+++ b/templates/nginx/service.yaml
@@ -2,6 +2,7 @@
 apiVersion: v1
 kind: Service
 metadata:
+  namespace: {{ .Release.Namespace | quote }}
 {{- if eq .Values.expose.type "clusterIP" }}
 {{- $clusterIP := .Values.expose.clusterIP }}
   name: {{ $clusterIP.name }}
diff --git a/templates/notary/notary-secret.yaml b/templates/notary/notary-secret.yaml
index dc9f619..f01a606 100644
--- a/templates/notary/notary-secret.yaml
+++ b/templates/notary/notary-secret.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.notary-server" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: notary
diff --git a/templates/notary/notary-server.yaml b/templates/notary/notary-server.yaml
index 753f2ec..d986132 100644
--- a/templates/notary/notary-server.yaml
+++ b/templates/notary/notary-server.yaml
@@ -3,6 +3,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.notary-server" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: notary-server
@@ -14,6 +15,7 @@ spec:
       component: notary-server
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: notary-server
@@ -37,7 +39,7 @@ spec:
       automountServiceAccountToken: {{ .Values.notary.server.automountServiceAccountToken | default false }}
       containers:
       - name: notary-server
-        image: {{ .Values.notary.server.image.repository }}:{{ .Values.notary.server.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.notary.server.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/notary/notary-signer.yaml b/templates/notary/notary-signer.yaml
index 15987b8..9d6fa2b 100644
--- a/templates/notary/notary-signer.yaml
+++ b/templates/notary/notary-signer.yaml
@@ -3,6 +3,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: {{ template "harbor.notary-signer" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: notary-signer
@@ -14,6 +15,7 @@ spec:
       component: notary-signer
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: notary-signer
@@ -36,7 +38,7 @@ spec:
       automountServiceAccountToken: {{ .Values.notary.signer.automountServiceAccountToken | default false }}
       containers:
       - name: notary-signer
-        image: {{ .Values.notary.signer.image.repository }}:{{ .Values.notary.signer.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.notary.signer.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/notary/notary-svc.yaml b/templates/notary/notary-svc.yaml
index f02ba3c..b23318b 100644
--- a/templates/notary/notary-svc.yaml
+++ b/templates/notary/notary-svc.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: {{ template "harbor.notary-server" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
@@ -20,6 +21,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: {{ template "harbor.notary-signer" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/portal/configmap.yaml b/templates/portal/configmap.yaml
index 6ffed32..e7bfd85 100644
--- a/templates/portal/configmap.yaml
+++ b/templates/portal/configmap.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.portal" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/portal/deployment.yaml b/templates/portal/deployment.yaml
index 934dc56..b58f5ac 100644
--- a/templates/portal/deployment.yaml
+++ b/templates/portal/deployment.yaml
@@ -2,6 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: "{{ template "harbor.portal" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: portal
@@ -14,6 +15,7 @@ spec:
       component: portal
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.matchLabels" . | indent 8 }}
         component: portal
@@ -40,7 +42,7 @@ spec:
       automountServiceAccountToken: {{ .Values.portal.automountServiceAccountToken | default false }}
       containers:
       - name: portal
-        image: {{ .Values.portal.image.repository }}:{{ .Values.portal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.portal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
 {{- if .Values.portal.resources }}
         resources:
diff --git a/templates/portal/service.yaml b/templates/portal/service.yaml
index c0a3a20..1b29229 100644
--- a/templates/portal/service.yaml
+++ b/templates/portal/service.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.portal" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/portal/tls.yaml b/templates/portal/tls.yaml
index de63f4e..e61a7d3 100644
--- a/templates/portal/tls.yaml
+++ b/templates/portal/tls.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.portal.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/redis/service.yaml b/templates/redis/service.yaml
index 79c95c3..d774706 100644
--- a/templates/redis/service.yaml
+++ b/templates/redis/service.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: {{ template "harbor.redis" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/redis/statefulset.yaml b/templates/redis/statefulset.yaml
index 74b7581..40070dd 100644
--- a/templates/redis/statefulset.yaml
+++ b/templates/redis/statefulset.yaml
@@ -4,6 +4,7 @@ apiVersion: apps/v1
 kind: StatefulSet
 metadata:
   name: {{ template "harbor.redis" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: redis
@@ -16,6 +17,7 @@ spec:
       component: redis
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: redis
@@ -38,7 +40,7 @@ spec:
       terminationGracePeriodSeconds: 120
       containers:
       - name: redis
-        image: {{ .Values.redis.internal.image.repository }}:{{ .Values.redis.internal.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.redis.internal.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           tcpSocket:
@@ -87,6 +89,7 @@ spec:
   volumeClaimTemplates:
   - metadata:
       name: data
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
       annotations:
diff --git a/templates/registry/registry-cm.yaml b/templates/registry/registry-cm.yaml
index 8af7969..df5932c 100644
--- a/templates/registry/registry-cm.yaml
+++ b/templates/registry/registry-cm.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.registry" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/registry/registry-dpl.yaml b/templates/registry/registry-dpl.yaml
index 80f0fce..49cd1f0 100644
--- a/templates/registry/registry-dpl.yaml
+++ b/templates/registry/registry-dpl.yaml
@@ -2,6 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: "{{ template "harbor.registry" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: registry
@@ -19,6 +20,7 @@ spec:
       component: registry
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: registry
@@ -50,7 +52,7 @@ spec:
       terminationGracePeriodSeconds: 120
       containers:
       - name: registry
-        image: {{ .Values.registry.registry.image.repository }}:{{ .Values.registry.registry.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.registry.registry.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
@@ -131,7 +133,7 @@ spec:
 {{ include "harbor.caBundleVolumeMount" . | indent 8 }}
         {{- end }}
       - name: registryctl
-        image: {{ .Values.registry.controller.image.repository }}:{{ .Values.registry.controller.image.tag }}
+        image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.registry.controller.image }}
         imagePullPolicy: {{ .Values.imagePullPolicy }}
         livenessProbe:
           httpGet:
diff --git a/templates/registry/registry-pvc.yaml b/templates/registry/registry-pvc.yaml
index 2112e22..8b73ba2 100644
--- a/templates/registry/registry-pvc.yaml
+++ b/templates/registry/registry-pvc.yaml
@@ -5,6 +5,7 @@ kind: PersistentVolumeClaim
 apiVersion: v1
 metadata:
   name: {{ template "harbor.registry" . }}
+  namespace: {{ .Release.Namespace | quote }}
   annotations:
   {{- range $key, $value := $registry.annotations }}
     {{ $key }}: {{ $value | quote }}
diff --git a/templates/registry/registry-secret.yaml b/templates/registry/registry-secret.yaml
index de8dada..c1b73cc 100644
--- a/templates/registry/registry-secret.yaml
+++ b/templates/registry/registry-secret.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.registry" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
@@ -37,6 +38,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.registry" . }}-htpasswd"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/registry/registry-svc.yaml b/templates/registry/registry-svc.yaml
index 749690e..c7e3d1d 100644
--- a/templates/registry/registry-svc.yaml
+++ b/templates/registry/registry-svc.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.registry" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/registry/registry-tls.yaml b/templates/registry/registry-tls.yaml
index 9d1862c..214b8a1 100644
--- a/templates/registry/registry-tls.yaml
+++ b/templates/registry/registry-tls.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.registry.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/templates/registry/registryctl-cm.yaml b/templates/registry/registryctl-cm.yaml
index 87aa5ff..61b2c5e 100644
--- a/templates/registry/registryctl-cm.yaml
+++ b/templates/registry/registryctl-cm.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: ConfigMap
 metadata:
   name: "{{ template "harbor.registryCtl" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 data:
diff --git a/templates/registry/registryctl-secret.yaml b/templates/registry/registryctl-secret.yaml
index 7009770..db9425b 100644
--- a/templates/registry/registryctl-secret.yaml
+++ b/templates/registry/registryctl-secret.yaml
@@ -2,6 +2,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.registryCtl" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/trivy/trivy-secret.yaml b/templates/trivy/trivy-secret.yaml
index 84652c7..b13f880 100644
--- a/templates/trivy/trivy-secret.yaml
+++ b/templates/trivy/trivy-secret.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: {{ template "harbor.trivy" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: Opaque
diff --git a/templates/trivy/trivy-sts.yaml b/templates/trivy/trivy-sts.yaml
index 78d915e..48b327d 100644
--- a/templates/trivy/trivy-sts.yaml
+++ b/templates/trivy/trivy-sts.yaml
@@ -4,6 +4,7 @@ apiVersion: apps/v1
 kind: StatefulSet
 metadata:
   name: {{ template "harbor.trivy" . }}
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
     component: trivy
@@ -16,6 +17,7 @@ spec:
       component: trivy
   template:
     metadata:
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
         component: trivy
@@ -43,7 +45,7 @@ spec:
       automountServiceAccountToken: {{ .Values.trivy.automountServiceAccountToken | default false }}
       containers:
         - name: trivy
-          image: {{ .Values.trivy.image.repository }}:{{ .Values.trivy.image.tag }}
+          image: {{ .Values.sourceRegistry }}/{{ include "harbor.image.repository.path" .Values.trivy.image }}
           imagePullPolicy: {{ .Values.imagePullPolicy }}
           securityContext:
             privileged: false
@@ -182,6 +184,7 @@ spec:
   volumeClaimTemplates:
   - metadata:
       name: data
+      namespace: {{ .Release.Namespace | quote }}
       labels:
 {{ include "harbor.labels" . | indent 8 }}
       annotations:
diff --git a/templates/trivy/trivy-svc.yaml b/templates/trivy/trivy-svc.yaml
index 24daf09..e0ae320 100644
--- a/templates/trivy/trivy-svc.yaml
+++ b/templates/trivy/trivy-svc.yaml
@@ -3,6 +3,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: "{{ template "harbor.trivy" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 spec:
diff --git a/templates/trivy/trivy-tls.yaml b/templates/trivy/trivy-tls.yaml
index a9c8330..58bce4e 100644
--- a/templates/trivy/trivy-tls.yaml
+++ b/templates/trivy/trivy-tls.yaml
@@ -4,6 +4,7 @@ apiVersion: v1
 kind: Secret
 metadata:
   name: "{{ template "harbor.internalTLS.trivy.secretName" . }}"
+  namespace: {{ .Release.Namespace | quote }}
   labels:
 {{ include "harbor.labels" . | indent 4 }}
 type: kubernetes.io/tls
diff --git a/values.yaml b/values.yaml
index a5550b8..cf886c3 100644
--- a/values.yaml
+++ b/values.yaml
@@ -1,7 +1,8 @@
+sourceRegistry: "public.ecr.aws/eks-anywhere"
 expose:
   # Set how to expose the service. Set the type as "ingress", "clusterIP", "nodePort" or "loadBalancer"
   # and fill the information in the corresponding section
-  type: ingress
+  type: nodePort
   tls:
     # Enable TLS or not.
     # Delete the "ssl-redirect" annotations in "expose.ingress.annotations" when TLS is disabled and "expose.type" is "ingress"
@@ -16,7 +17,7 @@ expose:
     # The tls certificate can be generated manually or by cert manager
     # 3) none: configure no tls certificate for the ingress. If the default
     # tls certificate is configured in the ingress controller, choose this option
-    certSource: auto
+    certSource: secret
     auto:
       # The common name used to generate the certificate, it's necessary
       # when the type isn't "ingress"
@@ -25,7 +26,7 @@ expose:
       # The name of secret which contains keys named:
       # "tls.crt" - the certificate
       # "tls.key" - the private key
-      secretName: ""
+      secretName: "harbor-tls-secret"
       # The name of secret which contains keys named:
       # "tls.crt" - the certificate
       # "tls.key" - the private key
@@ -122,13 +123,13 @@ expose:
 # the IP address of k8s node
 #
 # If Harbor is deployed behind the proxy, set it as the URL of proxy
-externalURL: https://core.harbor.domain
+externalURL: https://127.0.0.1:30003
 
 # The internal TLS used for harbor components secure communicating. In order to enable https
 # in each components tls cert files need to provided in advance.
 internalTLS:
   # If internal TLS enabled
-  enabled: false
+  enabled: true
   # There are three ways to provide tls
   # 1) "auto" will generate cert automatically
   # 2) "manual" need provide cert file manually in following value
@@ -355,7 +356,7 @@ imagePullSecrets:
 # and chartmuseum): "RollingUpdate" or "Recreate"
 # Set it as "Recreate" when "RWM" for volumes isn't supported
 updateStrategy:
-  type: RollingUpdate
+  type: Recreate
 
 # debug, info, warning, error or fatal
 logLevel: info
@@ -369,7 +370,7 @@ harborAdminPassword: "Harbor12345"
 caSecretName: ""
 
 # The secret key used for encryption. Must be a string of 16 chars.
-secretKey: "not-a-secure-key"
+secretKey: ""
 
 # The proxy settings for updating trivy vulnerabilities from the Internet and replicating
 # artifacts from/to the registries that cannot be reached directly
@@ -399,8 +400,8 @@ enableMigrateHelmHook: false
 # If service exposed via "ingress", the Nginx will not be used
 nginx:
   image:
-    repository: goharbor/nginx-photon
-    tag: v2.5.1
+    repository: harbor/harbor-nginx
+    digest: {{harbor/harbor-nginx}}
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -421,8 +422,8 @@ nginx:
 
 portal:
   image:
-    repository: goharbor/harbor-portal
-    tag: v2.5.1
+    repository: harbor/harbor-portal
+    digest: {{harbor/harbor-portal}}
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -443,8 +444,8 @@ portal:
 
 core:
   image:
-    repository: goharbor/harbor-core
-    tag: v2.5.1
+    repository: harbor/harbor-core
+    digest: {{harbor/harbor-core}}
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -486,8 +487,8 @@ core:
 
 jobservice:
   image:
-    repository: goharbor/harbor-jobservice
-    tag: v2.5.1
+    repository: harbor/harbor-jobservice
+    digest: {{harbor/harbor-jobservice}}
   replicas: 1
   revisionHistoryLimit: 10
   # set the service account to be used, default if left empty
@@ -526,16 +527,16 @@ registry:
   automountServiceAccountToken: false
   registry:
     image:
-      repository: goharbor/registry-photon
-      tag: v2.5.1
+      repository: harbor/harbor-registry
+      digest: {{harbor/harbor-registry}}
     # resources:
     #  requests:
     #    memory: 256Mi
     #    cpu: 100m
   controller:
     image:
-      repository: goharbor/harbor-registryctl
-      tag: v2.5.1
+      repository: harbor/harbor-registryctl
+      digest: {{harbor/harbor-registryctl}}
 
     # resources:
     #  requests:
@@ -584,7 +585,7 @@ registry:
     dryrun: false
 
 chartmuseum:
-  enabled: true
+  enabled: false
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -592,8 +593,8 @@ chartmuseum:
   # Harbor defaults ChartMuseum to returning relative urls, if you want using absolute url you should enable it by change the following value to 'true'
   absoluteUrl: false
   image:
-    repository: goharbor/chartmuseum-photon
-    tag: v2.5.1
+    repository: harbor/harbor-chartmuseum
+    digest: {{harbor/harbor-chartmuseum}}
   replicas: 1
   revisionHistoryLimit: 10
   # resources:
@@ -615,9 +616,8 @@ trivy:
   enabled: true
   image:
     # repository the repository for Trivy adapter image
-    repository: goharbor/trivy-adapter-photon
-    # tag the tag for Trivy adapter image
-    tag: v2.5.1
+    repository: harbor/harbor-trivy
+    digest: {{harbor/harbor-trivy}}
   # set the service account to be used, default if left empty
   serviceAccountName: ""
   # mount the service account token
@@ -682,15 +682,15 @@ trivy:
   priorityClassName:
 
 notary:
-  enabled: true
+  enabled: false
   server:
     # set the service account to be used, default if left empty
     serviceAccountName: ""
     # mount the service account token
     automountServiceAccountToken: false
     image:
-      repository: goharbor/notary-server-photon
-      tag: v2.5.1
+      repository: harbor/harbor-notary-server
+      digest: {{harbor/harbor-notary-server}}
     replicas: 1
     # resources:
     #  requests:
@@ -709,8 +709,8 @@ notary:
     # mount the service account token
     automountServiceAccountToken: false
     image:
-      repository: goharbor/notary-signer-photon
-      tag: v2.5.1
+      repository: harbor/harbor-notary-signer
+      digest: {{harbor/harbor-notary-signer}}
     replicas: 1
     # resources:
     #  requests:
@@ -741,8 +741,8 @@ database:
     # mount the service account token
     automountServiceAccountToken: false
     image:
-      repository: goharbor/harbor-db
-      tag: v2.5.1
+      repository: harbor/harbor-db
+      digest: {{harbor/harbor-db}}
     # The initial superuser password for internal database
     password: "changeit"
     # The size limit for Shared memory, pgSQL use it for shared_buffer
@@ -805,8 +805,8 @@ redis:
     # mount the service account token
     automountServiceAccountToken: false
     image:
-      repository: goharbor/redis-photon
-      tag: v2.5.1
+      repository: harbor/harbor-redis
+      digest: {{harbor/harbor-redis}}
     # resources:
     #  requests:
     #    memory: 256Mi
@@ -846,8 +846,8 @@ exporter:
   # mount the service account token
   automountServiceAccountToken: false
   image:
-    repository: goharbor/harbor-exporter
-    tag: v2.5.1
+    repository: harbor/harbor-exporter
+    digest: {{harbor/harbor-exporter}}
   nodeSelector: {}
   tolerations: []
   affinity: {}
-- 
2.32.0 (Apple Git-132)

