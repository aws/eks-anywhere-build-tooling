From 0df6637c5bbbeb2470841c558dfc553ed4f29668 Mon Sep 17 00:00:00 2001
From: Pooja Trivedi <poojatrivedi@gmail.com>
Date: Thu, 14 Apr 2022 20:38:39 +0000
Subject: [PATCH] When checking availability while picking hardware to assign
 to machines, check the 'State' field of the Hardware along with checking the
 ownerName label

---
 controllers/tinkerbellcluster_controller.go | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/controllers/tinkerbellcluster_controller.go b/controllers/tinkerbellcluster_controller.go
index 04cd3c9..7e855e6 100644
--- a/controllers/tinkerbellcluster_controller.go
+++ b/controllers/tinkerbellcluster_controller.go
@@ -198,7 +198,18 @@ func nextHardware(ctx context.Context, k8sClient client.Client, selectors []stri
 		return nil, nil
 	}
 
-	return &availableHardwares.Items[0], nil
+	var i int
+	for i = 0; i < len(availableHardwares.Items); i++ {
+		if availableHardwares.Items[i].Status.State == tinkv1.HardwareAvailable {
+			break
+		}
+	}
+
+	if i >= len(availableHardwares.Items) {
+		return nil, nil
+	}
+
+	return &availableHardwares.Items[i], nil
 }
 
 func hardwareIP(hardware *tinkv1.Hardware) (string, error) {
-- 
2.25.1

