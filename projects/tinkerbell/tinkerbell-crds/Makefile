BASE_DIRECTORY:=$(abspath ../../../)
GIT_TAG=$(shell cat GIT_TAG)

REPO_OWNER=tinkerbell
REPO=tinkerbell

# Override COMPONENT so MAKE_ROOT points to this project, not the cloned repo
COMPONENT=tinkerbell/tinkerbell-crds

# Don't clone - we manually clone tinkerbell/tinkerbell mono-repo in pre-helm/build
REPO_NO_CLONE=true

IMAGE_NAMES=
BUILD_TARGETS=helm/build
RELEASE_TARGETS=helm/push

HAS_HELM_CHART=true
# Chart is generated by build script into _output/helm-chart
HELM_DIRECTORY=_output/helm-chart
HELM_SOURCE_REPOSITORY=tinkerbell
HELM_IMAGE_LIST=
HELM_CHART_NAMES=tinkerbell/tinkerbell-crds

EXCLUDE_FROM_UPGRADE_BUILDSPEC=true
EXCLUDE_FROM_CHECKSUMS_BUILDSPEC=true

include $(BASE_DIRECTORY)/Common.mk

# Clone tinkerbell mono-repo from GitHub (bypassing infra CLONE_URL which points to non-existent repo)
# Uses same pattern as Common.mk: directory rule + checkout/marker rule
$(REPO):
	source $(BUILD_LIB)/common.sh && retry git clone https://github.com/$(REPO_OWNER)/$(REPO).git $(REPO)

$(GIT_CHECKOUT_TARGET): | $(REPO)
	@rm -f $(REPO)/eks-anywhere-*
	git -C $(REPO) checkout --quiet -f $(GIT_TAG)
	@touch $@

# Override checkout-repo to use our clone rules + generate CRDs chart
.PHONY: checkout-repo
checkout-repo: $(GIT_CHECKOUT_TARGET)
	scripts/generate-crds-chart.sh $(MAKE_ROOT)/$(REPO) $(MAKE_ROOT)/$(REPO)/_output/helm-chart

.PHONY: verify
verify: checkout-repo
	scripts/verify.sh $(MAKE_ROOT)/$(REPO)/_output/helm-chart $(GIT_TAG)


########### DO NOT EDIT #############################
# To update call: make add-generated-help-block
# This is added to help document dynamic targets and support shell autocompletion
# Run make help for a formatted help block with all targets
include Help.mk
########### END GENERATED ###########################
