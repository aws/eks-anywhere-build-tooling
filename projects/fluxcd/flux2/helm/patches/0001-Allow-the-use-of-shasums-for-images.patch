From 5195e1a980e212019e44983b5e3a3c832e2e4d08 Mon Sep 17 00:00:00 2001
From: Terry Howe <tlhowe@amazon.com>
Date: Fri, 17 Dec 2021 09:35:40 -0700
Subject: [PATCH 1/3] Allow the use of shasums for images

---
 charts/flux2/templates/_helper.tpl                      | 7 +++++++
 charts/flux2/templates/helm-controller.yaml             | 2 +-
 charts/flux2/templates/image-automation-controller.yaml | 2 +-
 charts/flux2/templates/image-reflector-controller.yaml  | 2 +-
 charts/flux2/templates/kustomize-controller.yaml        | 2 +-
 charts/flux2/templates/notification-controller.yaml     | 2 +-
 charts/flux2/templates/pre-install-job.yaml             | 2 +-
 charts/flux2/templates/source-controller.yaml           | 2 +-
 8 files changed, 14 insertions(+), 7 deletions(-)
 create mode 100644 charts/flux2/templates/_helper.tpl

diff --git a/charts/flux2/templates/_helper.tpl b/charts/flux2/templates/_helper.tpl
new file mode 100644
index 0000000..6a36293
--- /dev/null
+++ b/charts/flux2/templates/_helper.tpl
@@ -0,0 +1,7 @@
+{{- define "template.image" -}}
+{{- if eq (substr 0 7 .tag) "sha256:" -}}
+{{- printf "%s@%s" .image .tag -}}
+{{- else -}}
+{{- printf "%s:%s" .image .tag -}}
+{{- end -}}
+{{- end -}}
diff --git a/charts/flux2/templates/helm-controller.yaml b/charts/flux2/templates/helm-controller.yaml
index 17b37c2..4250d8f 100644
--- a/charts/flux2/templates/helm-controller.yaml
+++ b/charts/flux2/templates/helm-controller.yaml
@@ -36,7 +36,7 @@ spec:
           valueFrom:
             fieldRef:
               fieldPath: metadata.namespace
-        image: {{ .Values.helmcontroller.image }}:{{ .Values.helmcontroller.tag }}
+        image: {{ template "template.image" .Values.helmcontroller }}
         imagePullPolicy: IfNotPresent
         livenessProbe:
           httpGet:
diff --git a/charts/flux2/templates/image-automation-controller.yaml b/charts/flux2/templates/image-automation-controller.yaml
index c3c6a58..3ac43a9 100644
--- a/charts/flux2/templates/image-automation-controller.yaml
+++ b/charts/flux2/templates/image-automation-controller.yaml
@@ -36,7 +36,7 @@ spec:
           valueFrom:
             fieldRef:
               fieldPath: metadata.namespace
-        image: {{ .Values.imageautomationcontroller.image }}:{{ .Values.imageautomationcontroller.tag }}
+        image: {{ template "template.image" .Values.imageautomationcontroller }}
         imagePullPolicy: IfNotPresent
         livenessProbe:
           httpGet:
diff --git a/charts/flux2/templates/image-reflector-controller.yaml b/charts/flux2/templates/image-reflector-controller.yaml
index 292930d..c78bf93 100644
--- a/charts/flux2/templates/image-reflector-controller.yaml
+++ b/charts/flux2/templates/image-reflector-controller.yaml
@@ -36,7 +36,7 @@ spec:
           valueFrom:
             fieldRef:
               fieldPath: metadata.namespace
-        image: {{ .Values.imagereflectorcontroller.image }}:{{ .Values.imagereflectorcontroller.tag }}
+        image: {{ template "template.image" .Values.imagereflectorcontroller }}
         imagePullPolicy: IfNotPresent
         livenessProbe:
           httpGet:
diff --git a/charts/flux2/templates/kustomize-controller.yaml b/charts/flux2/templates/kustomize-controller.yaml
index 1a1ea80..9ea3bdf 100644
--- a/charts/flux2/templates/kustomize-controller.yaml
+++ b/charts/flux2/templates/kustomize-controller.yaml
@@ -47,7 +47,7 @@ spec:
               name: {{ .Values.kustomizecontroller.envFrom.secret.name }}
           {{- end }}
         {{- end }}
-        image: {{ .Values.kustomizecontroller.image }}:{{ .Values.kustomizecontroller.tag }}
+        image: {{ template "template.image" .Values.kustomizecontroller }}
         imagePullPolicy: IfNotPresent
         livenessProbe:
           httpGet:
diff --git a/charts/flux2/templates/notification-controller.yaml b/charts/flux2/templates/notification-controller.yaml
index 72f99fb..e4beb80 100644
--- a/charts/flux2/templates/notification-controller.yaml
+++ b/charts/flux2/templates/notification-controller.yaml
@@ -35,7 +35,7 @@ spec:
           valueFrom:
             fieldRef:
               fieldPath: metadata.namespace
-        image: {{ .Values.notificationcontroller.image }}:{{ .Values.notificationcontroller.tag }}
+        image: {{ template "template.image" .Values.notificationcontroller }}
         imagePullPolicy: IfNotPresent
         livenessProbe:
           httpGet:
diff --git a/charts/flux2/templates/pre-install-job.yaml b/charts/flux2/templates/pre-install-job.yaml
index 74d7abe..9fb3ebe 100644
--- a/charts/flux2/templates/pre-install-job.yaml
+++ b/charts/flux2/templates/pre-install-job.yaml
@@ -27,7 +27,7 @@ spec:
       restartPolicy: Never
       containers:
       - name: flux-cli
-        image: {{ .Values.cli.image }}:{{ .Values.cli.tag }}
+        image: {{ template "template.image" .Values.cli }}
         command: ["/usr/local/bin/flux", "check",  "--pre", "--namespace", {{ .Release.Namespace }}]
       {{- with .Values.cli.nodeSelector }}
       nodeSelector: {{ toYaml . | nindent 8 }}
diff --git a/charts/flux2/templates/source-controller.yaml b/charts/flux2/templates/source-controller.yaml
index 218882c..dc7cb31 100644
--- a/charts/flux2/templates/source-controller.yaml
+++ b/charts/flux2/templates/source-controller.yaml
@@ -40,7 +40,7 @@ spec:
           valueFrom:
             fieldRef:
               fieldPath: metadata.namespace
-        image: {{ .Values.sourcecontroller.image }}:{{ .Values.sourcecontroller.tag }}
+        image: {{ template "template.image" .Values.sourcecontroller }}
         imagePullPolicy: IfNotPresent
         livenessProbe:
           httpGet:
-- 
2.29.2

